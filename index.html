<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELITE TRACKER - QUENTIN V14 DISCIPLINE</title>
    <link rel="apple-touch-icon" href="Logo.png">
    <link rel="icon" type="image/png" href="Logo.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00ff41">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;700;900&family=Orbitron:wght@900&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00ff41; --blue: #00d1ff; --gold: #ffd700; --bg: #060a10; --card: rgba(14, 18, 24, 0.97); --card-border: rgba(255,255,255,0.06); --radius: 18px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: white; font-family: 'Barlow', sans-serif; margin: 0; padding: 16px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; background-image: radial-gradient(ellipse at 50% 0%, rgba(0,255,65,0.03) 0%, transparent 60%); }
        .container { max-width: 420px; width: 100%; }

        /* START SCREEN OVERLAY */
        #startScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); background-image: radial-gradient(ellipse at 50% 30%, rgba(0,255,65,0.05) 0%, transparent 70%); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .start-card { background: var(--card); border: 1px solid rgba(0,255,65,0.2); padding: 32px 28px; border-radius: 28px; width: 100%; max-width: 360px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(0,255,65,0.03); }
        .energy-selector { display: flex; justify-content: center; gap: 18px; margin: 20px 0; }
        .e-btn { width: 44px; height: 44px; border-radius: 50%; border: 2px solid #333; cursor: pointer; transition: all 0.3s cubic-bezier(0.4,0,0.2,1); display: flex; align-items: center; justify-content: center; }
        .e-red { background: #ff4444; opacity: 0.3; } .e-white { background: #fff; opacity: 0.3; } .e-green { background: var(--neon); opacity: 0.3; }
        .e-btn.active { opacity: 1; transform: scale(1.15); border-color: #fff; box-shadow: 0 0 20px rgba(255,255,255,0.15); }

        /* DISCIPLINE SCORE CARD */
        .discipline-card { background: linear-gradient(145deg, rgba(0,255,65,0.04) 0%, rgba(0,209,255,0.04) 100%); border: 1px solid rgba(0,255,65,0.15); padding: 20px; border-radius: 24px; margin: 20px 0; position: relative; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.03); }
        .discipline-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle at 50% 50%, rgba(0,255,65,0.02) 0%, transparent 50%); pointer-events: none; }

        .discipline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; position: relative; z-index: 1; }
        .discipline-label { font-size: 0.65rem; font-weight: 900; color: var(--neon); text-transform: uppercase; letter-spacing: 2px; }
        .discipline-rank { font-size: 0.7rem; font-weight: 900; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }

        .discipline-score-circle { position: relative; width: 100px; height: 100px; margin: 0 auto 14px; }
        .score-svg { position: absolute; width: 100%; height: 100%; transform: rotate(-90deg); }
        .score-circle-bg { fill: none; stroke: rgba(255,255,255,0.04); stroke-width: 7; }
        .score-circle-fill { fill: none; stroke: var(--neon); stroke-width: 7; stroke-linecap: round; transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1); stroke-dasharray: 251; stroke-dashoffset: 251; filter: drop-shadow(0 0 8px var(--neon)); }
        .score-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 1; }
        .score-number { font-family: 'Orbitron', monospace; font-size: 2rem; font-weight: 900; color: var(--neon); line-height: 1; text-shadow: 0 0 20px var(--neon); }
        .score-label { font-size: 0.5rem; color: #555; text-transform: uppercase; font-weight: 900; letter-spacing: 2px; margin-top: 2px; }

        .discipline-breakdown { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; position: relative; z-index: 1; }
        .breakdown-item { background: rgba(0,0,0,0.35); padding: 10px 6px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.04); transition: border-color 0.3s; }
        .breakdown-value { font-size: 1.1rem; font-weight: 900; color: white; }
        .breakdown-label { font-size: 0.55rem; color: #666; text-transform: uppercase; margin-top: 3px; }
        .breakdown-item.active .breakdown-value { color: var(--neon); }
        .breakdown-item.active { border-color: rgba(0,255,65,0.15); }

        .streak-badge { display: inline-flex; align-items: center; gap: 4px; background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3); padding: 6px 14px; border-radius: 20px; font-size: 0.65rem; font-weight: 900; color: var(--gold); margin-top: 10px; position: relative; z-index: 1; }
        .streak-badge::before { content: 'üî•'; margin-right: 3px; }

        /* GLOBAL FORM ELEMENTS */
        input, textarea, select { width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; color: white; margin-bottom: 10px; box-sizing: border-box; font-family: 'Barlow'; font-size: 0.85rem; transition: border-color 0.2s, box-shadow 0.2s; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: rgba(0,255,65,0.3); box-shadow: 0 0 0 3px rgba(0,255,65,0.05); }
        input::placeholder, textarea::placeholder { color: #444; }
        select option { background-color: #12161c; color: white; }

        .top-info { display: flex; justify-content: space-between; font-size: 10px; color: rgba(0,255,65,0.6); letter-spacing: 2px; margin-bottom: 5px; font-weight: 700; }
        h1 { font-weight: 900; font-size: 1.8rem; margin: 0; letter-spacing: -1px; }
        h1 span { color: var(--neon); }

        /* TABS */
        .tabs { display: flex; gap: 0; margin: 20px 0; background: rgba(255,255,255,0.03); border-radius: 14px; padding: 4px; border: 1px solid rgba(255,255,255,0.05); }
        .tab { flex: 1; padding: 11px 5px; font-size: 0.75rem; font-weight: 900; color: #555; cursor: pointer; text-transform: uppercase; text-align: center; border-radius: 11px; transition: all 0.25s; border-bottom: none; }
        .tab.active { color: black; background: var(--neon); box-shadow: 0 2px 12px rgba(0,255,65,0.25); }

        /* CARDS */
        .card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--card-border); margin-bottom: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .label { font-size: 0.65rem; font-weight: 900; color: #555; text-transform: uppercase; margin-bottom: 10px; display: block; letter-spacing: 1px; }

        /* GAUGES */
        .gauge-row { display: flex; justify-content: space-around; margin: 20px 0; }
        .gauge { position: relative; width: 110px; height: 110px; display: flex; align-items: center; justify-content: center; }
        svg { position: absolute; width: 100%; height: 100%; transform: rotate(-90deg); }
        circle { fill: none; stroke-width: 8; stroke-linecap: round; }
        .circle-bg { stroke: rgba(255,255,255,0.04); }
        .circle-fill { stroke: var(--neon); transition: 0.8s; stroke-dasharray: 283; stroke-dashoffset: 283; }

        /* BUTTONS */
        .btn { width: 100%; padding: 15px; background: var(--neon); color: black; border: none; border-radius: 14px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; transition: all 0.2s; letter-spacing: 0.5px; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,255,65,0.25); }
        .btn:active { transform: translateY(0); }
        .btn-reset { background: transparent; color: #ff4444; border: 1px solid rgba(255,68,68,0.3); padding: 8px; font-size: 0.6rem; margin-top: 10px; }
        .btn-reset:hover { background: rgba(255,68,68,0.05); }

        /* PROGRESS BAR */
        .m-bar { height: 5px; background: rgba(255,255,255,0.05); border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .m-fill { height: 100%; background: linear-gradient(90deg, var(--blue), var(--neon)); width: 0%; transition: width 0.5s cubic-bezier(0.4,0,0.2,1); }

        /* MISSIONS */
        .mission-item { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: rgba(255,255,255,0.02); border-radius: 14px; margin-bottom: 8px; cursor: pointer; transition: background 0.2s; border: 1px solid transparent; }
        .mission-item:hover { background: rgba(255,255,255,0.04); }
        .check { width: 22px; height: 22px; border: 2px solid #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; transition: all 0.25s; }
        .check.done { background: var(--neon); border-color: var(--neon); color: black; box-shadow: 0 0 10px rgba(0,255,65,0.2); }
        .hist-item { font-size: 0.75rem; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.04); color: #888; }
        .hist-date { color: var(--blue); font-weight: 900; margin-right: 10px; }

        #criticalBanner { cursor: pointer; transition: all 0.3s; }
        #criticalBanner.isDone { background: rgba(0,255,65,0.1) !important; color: var(--neon) !important; border: 1px solid rgba(0,255,65,0.3); box-shadow: none; }
        #congratsOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 255, 65, 0.95); z-index: 10001; color: black; flex-direction: column; align-items: center; justify-content: center; text-align: center; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* DAILY WRAP OVERLAY */
        #dailyWrapOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(3, 4, 6, 0.98); z-index: 10000; overflow-y: auto; padding: 20px; box-sizing: border-box; animation: fadeIn 0.3s; }
        .wrap-container { max-width: 400px; margin: 0 auto; }
        .wrap-header { text-align: center; margin-bottom: 25px; }
        .wrap-title { font-family: 'Orbitron', monospace; font-size: 1.8rem; font-weight: 900; color: var(--neon); margin: 0; text-transform: uppercase; letter-spacing: 2px; }
        .wrap-subtitle { font-size: 0.7rem; color: #666; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .wrap-card { background: var(--card); border: 1px solid rgba(0,255,65,0.2); border-radius: 20px; padding: 20px; margin-bottom: 15px; }
        .wrap-stat-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .wrap-stat-row:last-child { border-bottom: none; }
        .wrap-stat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; }
        .wrap-stat-value { font-size: 1.2rem; font-weight: 900; color: white; }
        .wrap-stat-value.success { color: var(--neon); }
        .wrap-stat-value.warning { color: #ff9800; }
        .wrap-score-big { text-align: center; padding: 20px; }
        .wrap-score-number { font-family: 'Orbitron', monospace; font-size: 3rem; font-weight: 900; color: var(--neon); text-shadow: 0 0 30px var(--neon); }
        .wrap-score-label { font-size: 0.7rem; color: #666; margin-top: 5px; text-transform: uppercase; letter-spacing: 2px; }
        .wrap-improvement { margin: 15px 0; }
        .wrap-improvement textarea { height: 60px; resize: none; }
        .wrap-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn-wrap-cancel { background: transparent; color: #888; border: 1px solid #444; }
        .btn-wrap-lock { background: var(--neon); color: black; position: relative; overflow: hidden; }
        .btn-wrap-lock::before { content: 'üîí'; margin-right: 8px; }
        .locked-badge { display: inline-block; background: rgba(255,215,0,0.2); border: 1px solid var(--gold); padding: 4px 10px; border-radius: 10px; font-size: 0.65rem; color: var(--gold); font-weight: 900; text-transform: uppercase; margin-left: 10px; }
        .locked-badge::before { content: 'üîí '; }
        
        /* COACH SECTION */
        .coach-card { background: linear-gradient(135deg, rgba(0,209,255,0.05) 0%, rgba(138,43,226,0.05) 100%); border: 2px solid rgba(0,209,255,0.3); border-radius: 20px; padding: 15px; margin-bottom: 15px; }
        .coach-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .coach-title { font-size: 0.7rem; font-weight: 900; color: var(--blue); text-transform: uppercase; letter-spacing: 2px; }
        .coach-badge { background: rgba(0,209,255,0.2); border: 1px solid var(--blue); padding: 3px 8px; border-radius: 10px; font-size: 0.6rem; color: var(--blue); font-weight: 900; }
        .coach-alert { background: rgba(0,0,0,0.3); border-left: 3px solid var(--blue); padding: 12px; border-radius: 10px; margin-bottom: 10px; }
        .coach-alert.warning { border-left-color: #ff9800; }
        .coach-alert.critical { border-left-color: #ff4444; }
        .coach-alert-title { font-size: 0.75rem; font-weight: 900; color: white; margin-bottom: 5px; text-transform: uppercase; }
        .coach-alert-desc { font-size: 0.7rem; color: #aaa; line-height: 1.4; margin-bottom: 8px; }
        .coach-action { font-size: 0.65rem; color: var(--neon); font-weight: 900; padding: 6px 12px; background: rgba(0,255,65,0.1); border: 1px solid var(--neon); border-radius: 8px; display: inline-block; cursor: pointer; transition: 0.3s; text-transform: uppercase; }
        .coach-action:hover { background: rgba(0,255,65,0.2); transform: translateY(-2px); }
        .coach-empty { text-align: center; padding: 20px; color: #666; font-size: 0.75rem; }
        .coach-empty::before { content: '‚úì'; display: block; font-size: 2rem; color: var(--neon); margin-bottom: 10px; }
        
        /* FOCUS MODE */
        #focusOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10002; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.3s; }
        .focus-close-btn { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.5rem; color: #888; transition: 0.3s; z-index: 10003; }
        .focus-close-btn:hover { background: rgba(255,255,255,0.2); color: white; transform: rotate(90deg); }
        .focus-container { text-align: center; max-width: 500px; padding: 20px; }
        .focus-title { font-family: 'Orbitron', monospace; font-size: 1rem; font-weight: 900; color: var(--neon); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 50px; opacity: 0.5; }
        .focus-timer { font-family: 'Orbitron', monospace; font-size: 6rem; font-weight: 900; color: white; line-height: 1; margin: 40px 0; text-shadow: 0 0 40px var(--neon); }
        .focus-progress-bar { width: 100%; max-width: 400px; height: 6px; background: rgba(255,255,255,0.05); border-radius: 10px; margin: 40px auto 20px; overflow: hidden; }
        .focus-progress-fill { height: 100%; background: var(--neon); width: 0%; transition: width 1s linear; box-shadow: 0 0 15px var(--neon); }
        .focus-message { font-size: 0.85rem; color: #666; margin: 20px 0; font-style: italic; }
        .focus-time-selector { display: flex; justify-content: center; gap: 15px; margin: 30px 0; }
        .focus-time-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #888; padding: 12px 20px; border-radius: 10px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; transition: 0.3s; }
        .focus-time-btn:hover { border-color: var(--neon); color: var(--neon); }
        .focus-time-btn.active { background: rgba(0,255,65,0.1); border-color: var(--neon); color: var(--neon); }
        .focus-actions { display: flex; gap: 15px; justify-content: center; margin-top: 30px; position: relative; z-index: 10; }
        .btn-focus-cancel { background: transparent; border: 1px solid #444; color: #888; padding: 12px 30px; border-radius: 10px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 0.7rem; transition: 0.3s; position: relative; z-index: 10; pointer-events: auto; }
        .btn-focus-cancel:hover { border-color: #666; color: #aaa; }
        .btn-focus { background: var(--neon); color: black; padding: 16px 40px; border: none; border-radius: 14px; font-weight: 900; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; box-shadow: 0 0 30px rgba(0,255,65,0.3); transition: 0.3s; }
        .btn-focus:hover { transform: translateY(-2px); box-shadow: 0 0 50px rgba(0,255,65,0.5); }
        
        /* FOCUS COMPLETE */
        .focus-complete { display: none; }
        .focus-complete-icon { font-size: 5rem; margin-bottom: 20px; animation: bounce 0.6s; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .focus-complete-title { font-family: 'Orbitron', monospace; font-size: 2rem; font-weight: 900; color: var(--neon); margin-bottom: 15px; text-transform: uppercase; }
        .focus-complete-desc { font-size: 0.85rem; color: #888; margin-bottom: 30px; }
        .focus-mission-select { width: 100%; max-width: 350px; margin: 0 auto 20px; }
        .focus-mission-item { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; transition: 0.3s; text-align: left; }
        .focus-mission-item:hover { background: rgba(0,255,65,0.05); border-color: var(--neon); }
        .focus-mission-item.selected { background: rgba(0,255,65,0.1); border-color: var(--neon); border-width: 2px; }
        .focus-mission-text { font-size: 0.85rem; color: white; font-weight: 700; }
        
        /* GUIDED JOURNAL */
        .journal-question { margin-bottom: 15px; }
        .journal-question-label { font-size: 0.7rem; color: var(--blue); font-weight: 900; text-transform: uppercase; margin-bottom: 8px; display: block; }
        .journal-question textarea { height: 60px; resize: vertical; }
        .journal-tags { display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; }
        .journal-tag { padding: 6px 12px; border-radius: 15px; font-size: 0.65rem; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.3s; border: 1px solid; }
        .journal-tag.tag-energy { background: rgba(255,68,68,0.1); border-color: #ff4444; color: #ff4444; }
        .journal-tag.tag-focus { background: rgba(0,209,255,0.1); border-color: var(--blue); color: var(--blue); }
        .journal-tag.tag-stress { background: rgba(255,152,0,0.1); border-color: #ff9800; color: #ff9800; }
        .journal-tag.tag-calm { background: rgba(0,255,65,0.1); border-color: var(--neon); color: var(--neon); }
        .journal-tag.tag-productive { background: rgba(138,43,226,0.1); border-color: #8a2be2; color: #8a2be2; }
        .journal-tag.active { opacity: 1; transform: scale(1.05); }
        .journal-tag:not(.active) { opacity: 0.5; }
        .journal-tag:hover { opacity: 1; }
        .journal-entry { background: rgba(255,255,255,0.02); padding: 12px; border-radius: 12px; margin-bottom: 10px; border-left: 3px solid var(--blue); }
        .journal-entry-date { font-size: 0.7rem; color: var(--blue); font-weight: 900; margin-bottom: 8px; }
        .journal-entry-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px; }
        .journal-entry-tag { padding: 3px 8px; border-radius: 10px; font-size: 0.6rem; font-weight: 700; }
        .journal-entry-text { font-size: 0.75rem; color: #aaa; line-height: 1.5; margin-top: 5px; }
        .journal-entry-q { color: #666; font-size: 0.65rem; margin-top: 8px; }
        
        /* MICRO-LEARNING */
        .mind-score-mini { display: inline-flex; align-items: center; gap: 8px; background: rgba(138,43,226,0.1); border: 1px solid #8a2be2; padding: 6px 12px; border-radius: 12px; font-size: 0.7rem; font-weight: 900; color: #8a2be2; }
        .qcm-card { background: linear-gradient(135deg, rgba(138,43,226,0.05) 0%, rgba(0,209,255,0.05) 100%); border: 2px solid rgba(138,43,226,0.3); border-radius: 20px; padding: 20px; margin-bottom: 15px; }
        .qcm-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .qcm-title { font-size: 0.7rem; font-weight: 900; color: #8a2be2; text-transform: uppercase; letter-spacing: 2px; }
        .qcm-score { font-size: 0.65rem; color: #8a2be2; font-weight: 900; }
        .qcm-question { font-size: 0.85rem; color: white; font-weight: 700; margin-bottom: 15px; line-height: 1.4; }
        .qcm-answers { display: flex; flex-direction: column; gap: 10px; }
        .qcm-answer { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; cursor: pointer; transition: 0.3s; font-size: 0.75rem; }
        .qcm-answer:hover { background: rgba(138,43,226,0.1); border-color: #8a2be2; }
        .qcm-answer.correct { background: rgba(0,255,65,0.2); border-color: var(--neon); color: var(--neon); }
        .qcm-answer.wrong { background: rgba(255,68,68,0.2); border-color: #ff4444; color: #ff4444; }
        .qcm-answer.disabled { opacity: 0.5; cursor: not-allowed; }
        .qcm-explanation { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 10px; margin-top: 15px; font-size: 0.7rem; color: #aaa; border-left: 3px solid #8a2be2; display: none; }
        .qcm-next { margin-top: 15px; }

        /* CHEF IA */
        .chef-card { background: linear-gradient(135deg, rgba(255,140,0,0.06) 0%, rgba(255,215,0,0.06) 100%); border: 2px solid rgba(255,140,0,0.35); border-radius: 20px; padding: 18px; margin-bottom: 15px; }
        .chef-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        .chef-title { font-size: 0.7rem; font-weight: 900; color: #ff8c00; text-transform: uppercase; letter-spacing: 2px; }
        .chef-badge { background: rgba(255,140,0,0.2); border: 1px solid #ff8c00; padding: 3px 9px; border-radius: 10px; font-size: 0.6rem; color: #ff8c00; font-weight: 900; }
        .chef-textarea { width: 100%; min-height: 80px; padding: 12px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,140,0,0.25); border-radius: 12px; color: white; font-family: 'Barlow', sans-serif; font-size: 0.82rem; resize: vertical; box-sizing: border-box; margin-bottom: 10px; }
        .chef-textarea::placeholder { color: #666; }
        .chef-textarea:focus { outline: none; border-color: #ff8c00; }
        .btn-chef { width: 100%; padding: 13px; background: linear-gradient(135deg, #ff8c00, #ffd700); color: #000; border: none; border-radius: 12px; font-weight: 900; font-size: 0.72rem; text-transform: uppercase; cursor: pointer; letter-spacing: 1px; transition: 0.25s; }
        .btn-chef:hover { transform: translateY(-2px); box-shadow: 0 4px 18px rgba(255,140,0,0.35); }
        .btn-chef:disabled { opacity: 0.45; cursor: not-allowed; transform: none; box-shadow: none; }
        .chef-response { margin-top: 14px; display: none; }
        .chef-response-header { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .chef-response-dot { width: 8px; height: 8px; border-radius: 50%; background: #ff8c00; box-shadow: 0 0 8px #ff8c00; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.3; } }
        .chef-response-label { font-size: 0.6rem; color: #ff8c00; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }
        .chef-response-body { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,140,0,0.2); border-radius: 12px; padding: 14px; font-size: 0.78rem; color: #ddd; line-height: 1.6; white-space: pre-wrap; }
        .chef-loading { color: #ff8c00; font-size: 0.75rem; font-style: italic; padding: 10px 0; text-align: center; }
    </style>
</head>
<body>

<div id="congratsOverlay" onclick="this.style.display='none'">
    <h1 style="font-size: 5rem; margin: 0;">üèÜ</h1>
    <h2 style="font-weight: 900; font-size: 2rem;">MISSION CRITIQUE VALID√âE</h2>
    <p style="font-weight: 700; text-transform: uppercase;">Quentin, le mode √âlite est activ√©.</p>
    <p style="font-size: 0.8rem; margin-top: 20px;">(Clique pour fermer)</p>
</div>

<div id="dailyWrapOverlay">
    <div class="wrap-container">
        <div class="wrap-header">
            <h2 class="wrap-title">Daily Wrap</h2>
            <p class="wrap-subtitle" id="wrapDate">---</p>
        </div>
        
        <div class="wrap-card">
            <div class="wrap-score-big">
                <div class="wrap-score-number" id="wrapScore">0</div>
                <div class="wrap-score-label">Score de Discipline</div>
            </div>
        </div>
        
        <div class="wrap-card">
            <div class="wrap-stat-row">
                <span class="wrap-stat-label">Prot√©ines</span>
                <span class="wrap-stat-value" id="wrapProt">0g / 0g</span>
            </div>
            <div class="wrap-stat-row">
                <span class="wrap-stat-label">Calories</span>
                <span class="wrap-stat-value" id="wrapCal">0 / 2800</span>
            </div>
            <div class="wrap-stat-row">
                <span class="wrap-stat-label">Missions</span>
                <span class="wrap-stat-value" id="wrapMissions">0 / 0</span>
            </div>
            <div class="wrap-stat-row">
                <span class="wrap-stat-label">Mission Critique</span>
                <span class="wrap-stat-value" id="wrapCrit">‚ùå</span>
            </div>
        </div>
        
        <div class="wrap-card">
            <span class="label">Une am√©lioration pour demain</span>
            <div class="wrap-improvement">
                <textarea id="wrapImprovement" placeholder="Ex: Augmenter les prot√©ines au petit-d√©j..."></textarea>
            </div>
        </div>
        
        <div class="wrap-actions">
            <button class="btn btn-wrap-cancel" onclick="closeDailyWrap()">Annuler</button>
            <button class="btn btn-wrap-lock" onclick="lockDay()">Valider la journ√©e</button>
        </div>
    </div>
</div>

<div id="focusOverlay">
    <div class="focus-close-btn" onclick="closeFocusOverlay()">‚úï</div>
    <div class="focus-container">
        <!-- TIME SELECTOR -->
        <div id="focusSelector">
            <div class="focus-title">üéØ Mode Focus</div>
            <p style="color:#888; font-size:0.85rem; margin:30px 0 20px;">Choisis ta dur√©e :</p>
            <div class="focus-time-selector">
                <div class="focus-time-btn" onclick="selectFocusTime(15)">15 min</div>
                <div class="focus-time-btn active" onclick="selectFocusTime(25)">25 min</div>
                <div class="focus-time-btn" onclick="selectFocusTime(45)">45 min</div>
                <div class="focus-time-btn" onclick="selectFocusTime(60)">60 min</div>
            </div>
            <div class="focus-actions">
                <button class="btn-focus-cancel" onclick="closeFocusOverlay()">Annuler</button>
                <button class="btn-focus" onclick="confirmFocusTime()">D√©marrer</button>
            </div>
        </div>
        
        <!-- TIMER ACTIVE -->
        <div id="focusTimer" style="display:none;">
            <div class="focus-title">üéØ Mode Focus</div>
            <div class="focus-timer" id="focusTimeDisplay">25:00</div>
            <div class="focus-progress-bar">
                <div class="focus-progress-fill" id="focusProgressFill"></div>
            </div>
            <div class="focus-message" id="focusMessage">Concentre-toi. Pas de distraction.</div>
            <button class="btn-focus-cancel" onclick="cancelFocusSession()" style="margin-top: 30px;">Abandonner</button>
        </div>
        
        <!-- COMPLETE SCREEN -->
        <div id="focusComplete" class="focus-complete">
            <div class="focus-complete-icon">üèÜ</div>
            <h2 class="focus-complete-title">Session Termin√©e !</h2>
            <p class="focus-complete-desc">25 minutes de focus intense. Valide une mission :</p>
            <div class="focus-mission-select" id="focusMissionList"></div>
            <div class="focus-actions">
                <button class="btn-focus-cancel" onclick="closeFocusOverlay()">Plus tard</button>
                <button class="btn-focus" onclick="completeFocusMission()">Valider</button>
            </div>
        </div>
    </div>
</div>

<div id="startScreen" style="display:none;">
    <div class="start-card">
        <h2 style="font-weight:900; margin-top:0;">READY, <span style="color:var(--neon)">QUENTIN?</span></h2>
        <span class="label">√ânergie du jour</span>
        <div class="energy-selector">
            <div class="e-btn e-red" onclick="selE(this,'low')">üî¥</div>
            <div class="e-btn e-white" onclick="selE(this,'mid')">‚ö™</div>
            <div class="e-btn e-green active" onclick="selE(this,'high')">üü¢</div>
        </div>
        <span class="label">Motivation</span>
        <select id="startMotiv">
            <option value="Basse">Basse - Discipline requise</option>
            <option value="Moyenne" selected>Moyenne - Focus</option>
            <option value="Haute">Haute - Mode B√™te</option>
        </select>
        <span class="label">Mission Critique (Priorit√© #1)</span>
        <input type="text" id="startCrit" placeholder="Ex: S√©ance Jambes lourde">
        <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:15px; margin:15px 0; font-size:0.7rem; text-align:left;">
            <div style="margin-bottom:5px;">üéØ Objectif : <span id="startP">0</span>g Prot√©ines</div>
            <div style="margin-bottom:5px;">üî• Cible : <span id="startC">2800</span> kcal</div>
            <div style="font-style:italic; color:var(--blue); margin-top:10px;" id="startQuote"></div>
        </div>
        <button class="btn" onclick="finishStart()">D√©marrer la journ√©e</button>
    </div>
</div>

<div class="container">
    <div class="top-info"><span id="headerDate">---</span><span>V14 DISCIPLINE</span></div>
    <h1>Bonjour, <span>Quentin</span></h1>

    <!-- DISCIPLINE SCORE CARD -->
    <div class="discipline-card">
        <div class="discipline-header">
            <span class="discipline-label">Score Discipline</span>
            <span class="discipline-rank" id="rankLabel">D√âBUTANT</span>
        </div>
        <div class="discipline-score-circle">
            <svg class="score-svg">
                <circle class="score-circle-bg" cx="45" cy="45" r="40"/>
                <circle id="scoreCircle" class="score-circle-fill" cx="45" cy="45" r="40"/>
            </svg>
            <div class="score-value">
                <div class="score-number" id="scoreNumber">0</div>
                <div class="score-label">POINTS</div>
            </div>
        </div>
        <div class="discipline-breakdown">
            <div class="breakdown-item" id="bd-missions">
                <div class="breakdown-value" id="bd-missions-val">0%</div>
                <div class="breakdown-label">Missions</div>
            </div>
            <div class="breakdown-item" id="bd-crit">
                <div class="breakdown-value" id="bd-crit-val">0</div>
                <div class="breakdown-label">Critique</div>
            </div>
            <div class="breakdown-item" id="bd-prot">
                <div class="breakdown-value" id="bd-prot-val">0%</div>
                <div class="breakdown-label">Prot√©ines</div>
            </div>
            <div class="breakdown-item" id="bd-streak">
                <div class="breakdown-value" id="bd-streak-val">0</div>
                <div class="breakdown-label">Streak</div>
            </div>
        </div>
        <center><div class="streak-badge" id="streakBadge">S√âRIE : 0 JOURS</div></center>
        <center style="margin-top:10px;"><div class="mind-score-mini">üß† Esprit : <span id="mindScoreDisplay">0</span> pts</div></center>
    </div>

    <!-- FOCUS MODE BUTTON -->
    <button class="btn" onclick="startFocus()" style="background:var(--blue); margin-bottom:20px; width:100%;">üéØ Mode Focus</button>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('food', this)">Nutrition</div>
        <div class="tab" onclick="switchTab('jour', this)">Journal & Missions</div>
    </div>

    <div id="p-food" class="panel">
        <div class="card">
            <span class="label">R√©glages</span>
            <input type="number" id="weightIn" placeholder="Poids (kg)" oninput="updateUI()" style="margin-bottom:10px">
            <select id="goalSel" onchange="updateUI()" style="margin:0;">
                <option value="pdm">Prise de masse (x2.2)</option>
                <option value="seche">S√®che (x1.8)</option>
            </select>
        </div>
        <div id="nutriMsg" style="text-align:center; color:var(--neon); font-size:0.7rem; font-weight:900; margin-bottom:10px; text-transform:uppercase;"></div>
        <div class="gauge-row">
            <div class="gauge"><svg><circle class="circle-bg" cx="55" cy="55" r="45"/><circle id="fillP" class="circle-fill" cx="55" cy="55" r="45"/></svg>
                <div style="text-align:center"><span id="valP" style="font-size:1.3rem; font-weight:900">0</span><br><span style="font-size:0.5rem; color:#666">PROT / <span id="targetP">0</span></span></div>
            </div>
            <div class="gauge"><svg><circle class="circle-bg" cx="55" cy="55" r="45"/><circle id="fillC" class="circle-fill" cx="55" cy="55" r="45" style="stroke:var(--blue)"/></svg>
                <div style="text-align:center"><span id="valC" style="font-size:1.3rem; font-weight:900">0</span><br><span style="font-size:0.5rem; color:#666">KCAL / 2800</span></div>
            </div>
        </div>
        <div class="card">
            <span class="label">Entr√©e Rapide (Auto-Calcul)</span>
            <input type="text" id="iaIn" placeholder="Ex: 3 carottes, 500g de poisson...">
            <button class="btn" onclick="smartAdd()" style="background:var(--blue); margin-bottom:10px">Calculer & Ajouter</button>
            <div style="display:flex; gap:5px;"><input type="number" id="manP" placeholder="P" style="margin:0"><input type="number" id="manC" placeholder="Cal" style="margin:0"><button class="btn" onclick="addMan()" style="width:60px">+</button></div>
            <button class="btn btn-reset" onclick="resetDay()">R√©initialiser la journ√©e</button>
        </div>
        <canvas id="chart"></canvas>
    </div>

    <!-- CHEF IA - dans le tab Nutrition -->
    <div id="chefIASection" style="display:none;">
        <div class="chef-card">
            <div class="chef-header">
                <span class="chef-title">üë®‚Äçüç≥ Chef IA</span>
                <span class="chef-badge">RECETTES IA</span>
            </div>
            <textarea class="chef-textarea" id="userInput" placeholder="Ex: j'ai du poulet, du riz, des courgettes et de l'ail..."></textarea>
            <button class="btn-chef" onclick="demanderIA()">üç≥ G√©n√®re mes recettes</button>
            <div id="conversation-history" style="margin-top:14px; max-height:400px; overflow-y:auto;"></div>
            <div id="zone-reponse" style="margin-top:14px; padding:14px; border-radius:12px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,140,0,0.2); color:#ddd; font-size:0.78rem; line-height:1.6; display:none;"></div>
        </div>
    </div>

    <div id="p-jour" class="panel" style="display:none">

        <!-- 1. SAGESSE ELITE (tout en haut) -->
        <div style="background: linear-gradient(135deg, rgba(138,43,226,0.08) 0%, rgba(0,209,255,0.06) 100%); border: 2px solid rgba(138,43,226,0.3); border-radius: 20px; padding: 18px; margin-bottom: 15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 14px;">
                <span style="font-size: 0.75rem; font-weight: 900; color: #8a2be2; text-transform: uppercase; letter-spacing: 2px;">üíé Sagesse ELITE</span>
            </div>

            <!-- Citation du jour -->
            <div style="background: rgba(0,0,0,0.35); border-radius: 14px; padding: 16px; margin-bottom: 12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                    <span style="font-size: 0.6rem; font-weight: 900; color: var(--blue); text-transform: uppercase; letter-spacing: 1px;">üí¨ Citation du jour</span>
                    <button onclick="regenererCitation()" style="background:rgba(0,209,255,0.1); border:1px solid var(--blue); color:var(--blue); padding:5px 12px; border-radius:8px; cursor:pointer; font-size:0.6rem; font-weight:700;">üîÑ Autre</button>
                </div>
                <div id="qBox" style="border-left: 3px solid var(--blue); padding-left: 14px; font-style: italic; color: #bbb; font-size: 0.9rem; line-height: 1.6;"></div>
            </div>

            <!-- Mot du jour -->
            <div style="background: rgba(0,0,0,0.35); border-radius: 14px; padding: 16px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                    <span style="font-size: 0.6rem; font-weight: 900; color: var(--neon); text-transform: uppercase; letter-spacing: 1px;">üìñ Mot du jour</span>
                    <button onclick="regenererMot()" style="background:rgba(0,255,65,0.1); border:1px solid var(--neon); color:var(--neon); padding:5px 12px; border-radius:8px; cursor:pointer; font-size:0.6rem; font-weight:700;">üîÑ Autre</button>
                </div>
                <p id="mTxt" style="font-size: 0.85rem; color: #ccc; margin: 0; line-height: 1.5;"></p>
            </div>
        </div>

        <!-- 2. MICRO-APPRENTISSAGE -->
        <div class="qcm-card" id="qcmCard">
            <div class="qcm-header">
                <span class="qcm-title">üß† Micro-Apprentissage</span>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button onclick="regenererQuiz()" style="background:rgba(138,43,226,0.1); border:1px solid #8a2be2; color:#8a2be2; padding:5px 12px; border-radius:8px; cursor:pointer; font-size:0.6rem; font-weight:700;">üîÑ Autre</button>
                    <span class="qcm-score">Score: <span id="qcmTotalScore">0</span> pts</span>
                </div>
            </div>
            <div id="qcmContent"></div>
        </div>

        <!-- 3. MISSION CRITIQUE -->
        <div id="criticalBanner" onclick="toggleCrit()" style="display:none; background: linear-gradient(135deg, var(--neon), #00cc33); color:#000; padding:14px 16px; border-radius: 14px; margin-bottom:15px; font-weight:900; font-size:0.75rem; text-align:center; text-transform:uppercase; box-shadow: 0 0 20px rgba(0,255,65,0.2);"></div>

        <!-- 4. MISSIONS / TACHES -->
        <div style="background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid rgba(0,255,65,0.1); margin-bottom: 15px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                <span class="label" id="missionStatus" style="margin:0;">Missions du jour</span>
            </div>
            <div id="motivLabel" style="font-size: 0.65rem; color: var(--neon); margin-bottom: 8px; font-weight: 700;"></div>
            <div class="m-bar"><div class="m-fill" id="mBar"></div></div>
            <div id="tList"></div>
            <div style="display:flex; gap:10px; margin-top:12px"><input type="text" id="tIn" placeholder="Nouvel objectif..." style="margin:0"><button class="btn" onclick="addT()" style="width:60px">+</button></div>
        </div>

        <!-- COACH SECTION -->
        <div class="coach-card">
            <div class="coach-header">
                <span class="coach-title">üí° Coach Logique</span>
                <span class="coach-badge" id="coachBadge">0 CONSEIL</span>
            </div>
            <div id="coachAlerts"></div>
        </div>

        <!-- 5. JOURNAL GUIDE -->
        <div style="background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid rgba(0,209,255,0.1); margin-bottom: 15px;">
            <span class="label" style="color: var(--blue);">üìù Journal Guid√©</span>

            <div class="journal-question">
                <span class="journal-question-label">‚úÖ Qu'est-ce que j'ai bien fait ?</span>
                <textarea id="journalGood" placeholder="Ex: J'ai atteint mes prot√©ines, s√©ance intense..."></textarea>
            </div>

            <div class="journal-question">
                <span class="journal-question-label">‚ö†Ô∏è Qu'est-ce qui a frein√© ?</span>
                <textarea id="journalBlock" placeholder="Ex: Manque de sommeil, trop de distractions..."></textarea>
            </div>

            <div class="journal-question">
                <span class="journal-question-label">üéØ Une am√©lioration demain ?</span>
                <textarea id="journalImprove" placeholder="Ex: Pr√©parer mes repas la veille..."></textarea>
            </div>

            <span class="journal-question-label">üè∑Ô∏è Comment je me sens ?</span>
            <div class="journal-tags" id="journalTags">
                <div class="journal-tag tag-energy" onclick="toggleJournalTag('energy')">üî¥ √ânergie basse</div>
                <div class="journal-tag tag-focus" onclick="toggleJournalTag('focus')">üéØ Focus √©lev√©</div>
                <div class="journal-tag tag-stress" onclick="toggleJournalTag('stress')">üò∞ Stress</div>
                <div class="journal-tag tag-calm" onclick="toggleJournalTag('calm')">üòå Calme</div>
                <div class="journal-tag tag-productive" onclick="toggleJournalTag('productive')">‚ö° Productif</div>
            </div>

            <button class="btn" onclick="saveGuidedJournal()">Enregistrer le journal</button>
        </div>

        <!-- 6. HISTORIQUE JOURNAL -->
        <div style="background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 15px;">
            <span class="label">üìö Historique du Journal</span>
            <div id="guidedJournalList" style="max-height: 300px; overflow-y: auto;"></div>
        </div>

        <!-- 7. TERMINER LA JOURNEE (tout en bas) -->
        <button class="btn" onclick="openDailyWrap()" style="background: linear-gradient(135deg, var(--blue), #0099cc); margin-bottom:15px; width:100%; padding:18px; font-size:0.8rem; border-radius:16px; box-shadow: 0 0 20px rgba(0,209,255,0.2);">üîí Terminer la journ√©e</button>
    </div>
</div>

<script>
    const FOOD_DB = { "poulet": {p: 27, c: 165, unit: 'g'}, "poisson": {p: 22, c: 120, unit: 'g'}, "saumon": {p: 20, c: 200, unit: 'g'}, "saucisse": {p: 12, c: 250, unit: 'u'}, "oeuf": {p: 6, c: 70, unit: 'u'}, "steak": {p: 25, c: 250, unit: 'g'}, "carotte": {p: 1, c: 40, unit: 'u'}, "courgette": {p: 1.2, c: 17, unit: 'u'}, "poivron": {p: 1, c: 30, unit: 'u'}, "skyr": {p: 10, c: 60, unit: 'g'}, "riz": {p: 3, c: 130, unit: 'g'}, "shaker": {p: 25, c: 120, unit: 'u'} };
    const MOTIVATION = ["La discipline est la m√®re du succ√®s.", "N'arr√™te pas quand tu es fatigu√©, arr√™te quand tu as fini.", "Le corps accomplit ce que l'esprit croit.", "Sois plus fort que tes excuses."];

    // ===== G√âN√âRATEUR DE CITATION IA =====
    let dailyQuoteCache = null;
    let lastQuoteDate = null;

    const THEMES_CITATIONS = [
        "la vie et les choix qu'on fait",
        "le courage et sortir de sa zone de confort",
        "la patience et la construction sur le long terme",
        "l'√©chec comme le√ßon et le rebond",
        "la confiance en soi et croire en ses r√™ves",
        "le temps qui passe et l'urgence d'agir",
        "la solitude du parcours et la fiert√© personnelle",
        "l'ambition et voir grand",
        "la gratitude et appr√©cier le chemin",
        "la libert√© et l'ind√©pendance d'esprit",
        "la cr√©ativit√© et penser diff√©remment",
        "le travail silencieux qui finit par payer",
        "se relever apr√®s une chute",
        "la force mentale face √† l'adversit√©",
        "la simplicit√© et l'essentiel dans la vie"
    ];

    async function genererCitationIA() {
        const today = new Date().toDateString();

        if (dailyQuoteCache && lastQuoteDate === today) {
            return dailyQuoteCache;
        }

        const theme = THEMES_CITATIONS[Math.floor(Math.random() * THEMES_CITATIONS.length)];

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: `G√©n√®re UNE citation inspirante et originale (maximum 20 mots) sur le th√®me : ${theme}. La citation peut √™tre invent√©e ou d'un auteur c√©l√®bre (philosophe, entrepreneur, artiste, sportif, √©crivain...). Si c'est d'un auteur, ajoute "‚Äî Pr√©nom Nom" √† la fin. R√©ponds UNIQUEMENT avec la citation, sans guillemets, sans pr√©ambule.`
                })
            });

            const data = await response.json();

            if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                const citation = data.candidates[0].content.parts[0].text.trim();
                const cleanQuote = citation.replace(/^["¬´¬ª']|["¬´¬ª']$/g, '').trim();

                dailyQuoteCache = cleanQuote;
                lastQuoteDate = today;

                localStorage.setItem('dailyQuote', cleanQuote);
                localStorage.setItem('dailyQuoteDate', today);

                return cleanQuote;
            }
        } catch (error) {
            console.error("Erreur g√©n√©ration citation:", error);
        }

        return MOTIVATION[Math.floor(Math.random() * MOTIVATION.length)];
    }

    function loadSavedQuote() {
        const savedQuote = localStorage.getItem('dailyQuote');
        const savedDate = localStorage.getItem('dailyQuoteDate');
        const today = new Date().toDateString();

        if (savedQuote && savedDate === today) {
            dailyQuoteCache = savedQuote;
            lastQuoteDate = savedDate;
            return savedQuote;
        }
        return null;
    }

    async function regenererCitation() {
        const qBoxEl = document.getElementById('qBox');
        qBoxEl.innerText = 'Nouvelle citation en cours...';

        dailyQuoteCache = null;
        lastQuoteDate = null;
        localStorage.removeItem('dailyQuote');
        localStorage.removeItem('dailyQuoteDate');

        const newQuote = await genererCitationIA();
        qBoxEl.innerText = `"${newQuote}"`;
    }

    // ===== G√âN√âRATEUR MOT DU JOUR IA =====
    let dailyWordCache = null;
    let lastWordDate = null;

    const THEMES_MOTS = [
        "psychologie ou d√©veloppement personnel",
        "philosophie ou sagesse ancienne",
        "science ou biologie humaine",
        "√©conomie ou business",
        "nutrition ou sant√©",
        "sport ou performance physique",
        "histoire ou culture g√©n√©rale",
        "technologie ou innovation",
        "art ou cr√©ativit√©",
        "communication ou relations humaines",
        "leadership ou management",
        "astronomie ou nature",
        "m√©decine ou bien-√™tre",
        "litt√©rature ou √©criture",
        "strat√©gie ou prise de d√©cision"
    ];

    async function genererMotIA() {
        const today = new Date().toDateString();

        if (dailyWordCache && lastWordDate === today) {
            return dailyWordCache;
        }

        const theme = THEMES_MOTS[Math.floor(Math.random() * THEMES_MOTS.length)];

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: `G√©n√®re UN mot int√©ressant et peu connu du domaine : ${theme}. Donne sa d√©finition claire et concise (max 20 mots). Format EXACT : MOT EN MAJUSCULES : d√©finition. Exemple : S√âRENDIPIT√â : D√©couverte heureuse faite par hasard. R√©ponds UNIQUEMENT avec le mot et sa d√©finition, rien d'autre.`
                })
            });

            const data = await response.json();

            if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                const wordDef = data.candidates[0].content.parts[0].text.trim();

                dailyWordCache = wordDef;
                lastWordDate = today;

                localStorage.setItem('dailyWord', wordDef);
                localStorage.setItem('dailyWordDate', today);

                return wordDef;
            }
        } catch (error) {
            console.error("Erreur g√©n√©ration mot:", error);
        }

        const word = DICT[Math.floor(Math.random() * DICT.length)];
        return `${word.w} : ${word.d}`;
    }

    function loadSavedWord() {
        const savedWord = localStorage.getItem('dailyWord');
        const savedDate = localStorage.getItem('dailyWordDate');
        const today = new Date().toDateString();

        if (savedWord && savedDate === today) {
            dailyWordCache = savedWord;
            lastWordDate = savedDate;
            return savedWord;
        }
        return null;
    }

    async function regenererMot() {
        const mTxtEl = document.getElementById('mTxt');
        mTxtEl.innerHTML = 'Nouveau mot en cours...';

        dailyWordCache = null;
        lastWordDate = null;
        localStorage.removeItem('dailyWord');
        localStorage.removeItem('dailyWordDate');

        const newWord = await genererMotIA();
        const parts = newWord.split(' : ');
        if (parts.length >= 2) {
            mTxtEl.innerHTML = `<b style="color:var(--neon)">${parts[0]}</b> : ${parts.slice(1).join(' : ')}`;
        } else {
            mTxtEl.innerHTML = newWord;
        }
    }

    // ===== G√âN√âRATEUR QUIZ IA =====
    let dailyQuizCache = null;
    let lastQuizDate = null;

    const THEMES_QUIZ = [
        "psychologie ou biais cognitifs",
        "histoire et √©v√©nements marquants",
        "science ou biologie humaine",
        "g√©ographie ou cultures du monde",
        "nutrition ou alimentation",
        "√©conomie ou finance personnelle",
        "philosophie ou grandes id√©es",
        "technologie ou inventions",
        "sport ou performance",
        "astronomie ou univers",
        "art ou musique",
        "litt√©rature ou langues",
        "nature ou animaux",
        "sant√© ou m√©decine",
        "entrepreneuriat ou business"
    ];

    async function genererQuizIA() {
        const today = new Date().toDateString();

        if (dailyQuizCache && lastQuizDate === today) {
            return dailyQuizCache;
        }

        const theme = THEMES_QUIZ[Math.floor(Math.random() * THEMES_QUIZ.length)];

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: `G√©n√®re UNE question de quiz int√©ressante et √©ducative sur le th√®me : ${theme}. La question doit apprendre quelque chose d'utile ou surprenant. 4 r√©ponses possibles. Format JSON STRICT :
{
  "q": "La question en fran√ßais ?",
  "answers": ["R√©ponse A", "R√©ponse B", "R√©ponse C", "R√©ponse D"],
  "correct": 0,
  "explanation": "Explication courte et int√©ressante de la bonne r√©ponse"
}
Le champ "correct" doit √™tre l'index de la bonne r√©ponse (0, 1, 2 ou 3).
R√©ponds UNIQUEMENT avec le JSON, sans texte avant ou apr√®s, sans backticks markdown.`
                })
            });

            const data = await response.json();
            
            if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                let quizText = data.candidates[0].content.parts[0].text.trim();
                
                // Nettoyer les √©ventuels backticks markdown
                quizText = quizText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                
                const quiz = JSON.parse(quizText);
                
                dailyQuizCache = quiz;
                lastQuizDate = today;
                
                localStorage.setItem('dailyQuiz', JSON.stringify(quiz));
                localStorage.setItem('dailyQuizDate', today);
                
                return quiz;
            }
        } catch (error) {
            console.error("Erreur g√©n√©ration quiz:", error);
        }
        
        return null;
    }

    function loadSavedQuiz() {
        const savedQuiz = localStorage.getItem('dailyQuiz');
        const savedDate = localStorage.getItem('dailyQuizDate');
        const today = new Date().toDateString();
        
        if (savedQuiz && savedDate === today) {
            try {
                const quiz = JSON.parse(savedQuiz);
                dailyQuizCache = quiz;
                lastQuizDate = savedDate;
                return quiz;
            } catch (e) {
                return null;
            }
        }
        return null;
    }

    async function regenererQuiz() {
        dailyQuizCache = null;
        lastQuizDate = null;
        localStorage.removeItem('dailyQuiz');
        localStorage.removeItem('dailyQuizDate');

        const qcmContent = document.getElementById('qcmContent');
        if (qcmContent) qcmContent.innerHTML = '<div style="padding:15px; color:#888;">Nouvelle question en cours...</div>';

        await displayQCM();
    }
    const PROGRESS_PHRASES = ["Commence maintenant.", "C'est un bon d√©but.", "La moiti√© est faite.", "Rien ne t'arr√™te.", "√âLITE ATTEINTE !"];
    const DICT = [{w:"ABN√âGATION", d:"Sacrifice de soi pour une cause sup√©rieure."}, {w:"HYPERTROPHIE", d:"Croissance du volume musculaire."}, {w:"L'INDICE GLYC√âMIQUE", d:"Mesure la capacit√© d'un aliment √† √©lever le taux de sucre."}];
    const RANKS = [
        {min: 0, max: 19, label: "D√âBUTANT", color: "#888"},
        {min: 20, max: 39, label: "APPRENTI", color: "#00d1ff"},
        {min: 40, max: 59, label: "GUERRIER", color: "#00ff41"},
        {min: 60, max: 79, label: "CHAMPION", color: "#ffd700"},
        {min: 80, max: 100, label: "L√âGENDE", color: "#ff00ff"}
    ];
    
    // QCM QUESTIONS DATABASE
    const QCM_QUESTIONS = [
        {
            q: "Quelle est la meilleure fen√™tre pour consommer des prot√©ines apr√®s l'entra√Ænement ?",
            answers: ["Imm√©diatement", "Dans les 2h", "Peu importe", "Avant de dormir"],
            correct: 2,
            explanation: "Le 'timing' des prot√©ines importe peu. Ce qui compte : atteindre ton total quotidien."
        },
        {
            q: "Combien de temps faut-il pour cr√©er une habitude ?",
            answers: ["21 jours", "66 jours", "√áa d√©pend", "100 jours"],
            correct: 2,
            explanation: "√âtudes montrent 18-254 jours selon la complexit√©. Moyenne : 66 jours. Patience !"
        },
        {
            q: "Le meilleur moment pour s'entra√Æner ?",
            answers: ["Le matin", "Le soir", "Quand tu es constant", "Apr√®s manger"],
            correct: 2,
            explanation: "La constance bat le timing parfait. Choisis l'heure o√π tu peux √™tre r√©gulier."
        },
        {
            q: "Combien de repas par jour pour la masse ?",
            answers: ["6 repas", "3 repas", "Le total compte", "1 seul gros"],
            correct: 2,
            explanation: "Le nombre de repas importe peu. Ce qui compte : calories et prot√©ines totales."
        },
        {
            q: "Le cardio tue-t-il les gains ?",
            answers: ["Oui toujours", "Non jamais", "D√©pend du volume", "Seulement HIIT"],
            correct: 2,
            explanation: "Cardio mod√©r√© aide la r√©cup√©ration. L'exc√®s peut interf√©rer. Trouve l'√©quilibre."
        },
        {
            q: "Dormir moins de 7h affecte-t-il les performances ?",
            answers: ["Oui significativement", "Non pas vraiment", "Seulement si chronique", "√áa d√©pend"],
            correct: 0,
            explanation: "Le manque de sommeil r√©duit force, r√©cup√©ration et discipline. 7-9h minimum."
        },
        {
            q: "Les √©tirements avant l'entra√Ænement sont-ils essentiels ?",
            answers: ["Oui toujours", "Non dangereux", "Dynamiques oui", "Statiques non"],
            correct: 2,
            explanation: "√âtirements dynamiques > statiques avant effort. Mobilit√© active pr√©pare mieux."
        },
        {
            q: "La cr√©atine est-elle n√©cessaire ?",
            answers: ["Oui obligatoire", "Non inutile", "Utile mais pas obligatoire", "Dangereux"],
            correct: 2,
            explanation: "La cr√©atine aide mais n'est pas essentielle. Bases d'abord : calories, prot√©ines, sommeil."
        },
        {
            q: "Faut-il changer de programme souvent ?",
            answers: ["Chaque semaine", "Chaque mois", "Quand √ßa stagne", "Jamais"],
            correct: 2,
            explanation: "Change quand tu stagnes ou perds motivation. La progression bat la vari√©t√©."
        },
        {
            q: "L'eau froide apr√®s l'entra√Ænement am√©liore-t-elle la r√©cup√©ration ?",
            answers: ["Oui toujours", "Non jamais", "Pour inflammation seulement", "√áa d√©pend"],
            correct: 3,
            explanation: "D√©bat ouvert. Peut r√©duire inflammation mais aussi adaptation. √âcoute ton corps."
        }
    ];

    let db = JSON.parse(localStorage.getItem('elite_v14')) || {
        repas: [], tasks: [], notes: [], weight: 75, goal: 'pdm', lastStart: "", critTask: "", critDone: false, disciplineHistory: [], lockedDays: [], improvements: [], guidedJournals: [], dailyMoods: [], qcmAnswers: [], mindScore: 0
    };

    function calculateDisciplineScore() {
        const auj = new Date().toLocaleDateString();
        const todayTasks = db.tasks.filter(t => t.d === auj);
        const doneTasks = todayTasks.filter(t => t.done).length;
        const totalTasks = todayTasks.length;
        
        // Calcul des composantes du score
        const missionsScore = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 40) : 0; // 40 pts max
        const critScore = db.critDone ? 25 : 0; // 25 pts
        
        // Prot√©ines
        const targetP = Math.round(db.weight * (db.goal === 'pdm' ? 2.2 : 1.8));
        const logs = db.repas.filter(r => r.d === auj);
        const totP = logs.reduce((s, r) => s + r.p, 0);
        const protScore = Math.min(25, Math.round((totP / targetP) * 25)); // 25 pts max
        
        // Streak
        const streak = calculateStreak();
        const streakScore = Math.min(10, streak); // 10 pts max (1 pt par jour)
        
        const totalScore = missionsScore + critScore + protScore + streakScore;
        
        return {
            total: totalScore,
            missions: missionsScore,
            missionsPct: totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0,
            crit: critScore,
            prot: protScore,
            protPct: Math.min(100, Math.round((totP / targetP) * 100)),
            streak: streak,
            streakScore: streakScore
        };
    }

    function calculateStreak() {
        if (!db.disciplineHistory || db.disciplineHistory.length === 0) return 0;
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let streak = 0;
        let checkDate = new Date(today);
        
        // On v√©rifie les jours en remontant dans le temps
        for (let i = 0; i < 365; i++) {
            const dateStr = checkDate.toLocaleDateString();
            const dayRecord = db.disciplineHistory.find(h => h.date === dateStr);
            
            if (dayRecord && dayRecord.score >= 60) { // Seuil : 60+ points pour compter
                streak++;
                checkDate.setDate(checkDate.getDate() - 1);
            } else {
                break;
            }
        }
        
        return streak;
    }

    function saveDisciplineScore() {
        const auj = new Date().toLocaleDateString();
        const score = calculateDisciplineScore();
        
        // Mise √† jour ou ajout dans l'historique
        const existingIndex = db.disciplineHistory.findIndex(h => h.date === auj);
        if (existingIndex >= 0) {
            db.disciplineHistory[existingIndex] = { date: auj, score: score.total };
        } else {
            db.disciplineHistory.push({ date: auj, score: score.total });
        }
        
        // Garder seulement les 365 derniers jours
        if (db.disciplineHistory.length > 365) {
            db.disciplineHistory = db.disciplineHistory.slice(-365);
        }
        
        save();
    }

    function updateDisciplineUI() {
        const score = calculateDisciplineScore();
        
        // Mise √† jour du cercle de score
        document.getElementById('scoreNumber').innerText = score.total;
        const circumference = 2 * Math.PI * 40;
        const offset = circumference - (score.total / 100) * circumference;
        document.getElementById('scoreCircle').style.strokeDashoffset = offset;
        
        // Mise √† jour du rank
        const rank = RANKS.find(r => score.total >= r.min && score.total <= r.max);
        const rankLabel = document.getElementById('rankLabel');
        rankLabel.innerText = rank.label;
        rankLabel.style.color = rank.color;
        
        // Mise √† jour du breakdown
        document.getElementById('bd-missions-val').innerText = score.missionsPct + '%';
        document.getElementById('bd-crit-val').innerText = score.crit > 0 ? '‚úì' : '‚úó';
        document.getElementById('bd-prot-val').innerText = score.protPct + '%';
        document.getElementById('bd-streak-val').innerText = score.streak;
        
        // Active les items qui contribuent
        document.getElementById('bd-missions').className = score.missions > 0 ? 'breakdown-item active' : 'breakdown-item';
        document.getElementById('bd-crit').className = score.crit > 0 ? 'breakdown-item active' : 'breakdown-item';
        document.getElementById('bd-prot').className = score.prot > 0 ? 'breakdown-item active' : 'breakdown-item';
        document.getElementById('bd-streak').className = score.streakScore > 0 ? 'breakdown-item active' : 'breakdown-item';
        
        // Streak badge
        document.getElementById('streakBadge').innerText = score.streak > 0 ? `S√âRIE : ${score.streak} JOUR${score.streak > 1 ? 'S' : ''}` : 'COMMENCE TA S√âRIE';
        
        // Sauvegarder le score
        saveDisciplineScore();
    }

    function checkStart() {
        const auj = new Date().toLocaleDateString();
        if(db.lastStart !== auj) {
            document.getElementById('startScreen').style.display = 'flex';
            const targetP = Math.round(db.weight * (db.goal === 'pdm' ? 2.2 : 1.8));
            document.getElementById('startP').innerText = targetP;
            
            // Message adapt√© selon le mood s√©lectionn√©
            const motivationalQuotes = {
                high: [
                    "L'√©nergie est l√†. Fais-en bon usage.",
                    "Aujourd'hui, tu vas d√©truire tes limites.",
                    "Cette √©nergie ? C'est du carburant. Utilise-la."
                ],
                mid: [
                    "Pas besoin d'√™tre √† 100%. Commence juste.",
                    "La discipline surpasse la motivation.",
                    "Un pas √† la fois. C'est suffisant."
                ],
                low: [
                    "Fatigue ne veut pas dire faiblesse.",
                    "Garde juste le cap aujourd'hui.",
                    "Fais le minimum. C'est d√©j√† √©norme."
                ]
            };
            
            const defaultQuote = MOTIVATION[Math.floor(Math.random()*MOTIVATION.length)];
            document.getElementById('startQuote').innerText = `"${defaultQuote}"`;
        }
    }

    let selectedEnergy = 'high'; // Default
    
    function selE(el, val) {
        document.querySelectorAll('.e-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        selectedEnergy = val;
    }

    function toggleCrit() {
        // if(isDayLocked()) {
        //     alert("‚ö†Ô∏è Cette journ√©e est verrouill√©e ! Impossible de modifier.");
        //     return;
        // }
        db.critDone = !db.critDone;
        if(db.critDone) {
            document.getElementById('congratsOverlay').style.display = 'flex';
        }
        save(); updateUI();
    }

    function finishStart() {
        const crit = document.getElementById('startCrit').value;
        if(!crit) { alert("D√©finis ta mission critique !"); return; }
        
        const motivation = document.getElementById('startMotiv').value;
        
        db.critTask = crit; 
        db.critDone = false;
        db.lastStart = new Date().toLocaleDateString();
        
        // Sauvegarder le mood du jour
        if (!db.dailyMoods) db.dailyMoods = [];
        db.dailyMoods.push({
            date: new Date().toLocaleDateString(),
            energy: selectedEnergy,
            motivation: motivation
        });
        
        save();
        document.getElementById('startScreen').style.display = 'none';
        updateUI();
    }

    function switchTab(t, el) {
        document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        document.getElementById('p-'+t).style.display = 'block';
        el.classList.add('active');
        if(t === 'food') initChart();
    }

    function smartAdd() {
        // if(isDayLocked()) {
        //     alert("‚ö†Ô∏è Cette journ√©e est verrouill√©e ! Impossible de modifier.");
        //     return;
        // }
        const val = document.getElementById('iaIn').value.toLowerCase();
        let totalP = 0, totalC = 0;
        const numMatch = val.match(/(\d+)/);
        let qty = numMatch ? parseInt(numMatch[0]) : 1;
        for (let food in FOOD_DB) {
            if(val.includes(food)) {
                let data = FOOD_DB[food];
                let multiplier = (val.includes("kg")) ? qty * 10 : (val.includes("g") && data.unit === 'g' ? qty / 100 : qty);
                totalP += data.p * multiplier; totalC += data.c * multiplier;
            }
        }
        if(totalP > 0) { db.repas.push({ p: Math.round(totalP), c: Math.round(totalC), d: new Date().toLocaleDateString() }); save(); updateUI(); }
        document.getElementById('iaIn').value = '';
    }

    function addMan() {
        // if(isDayLocked()) {
        //     alert("‚ö†Ô∏è Cette journ√©e est verrouill√©e ! Impossible de modifier.");
        //     return;
        // }
        const p = parseInt(document.getElementById('manP').value) || 0;
        const c = parseInt(document.getElementById('manC').value) || 0;
        if(p > 0 || c > 0) { db.repas.push({ p, c: c || p*4, d: new Date().toLocaleDateString() }); save(); updateUI(); }
        document.getElementById('manP').value = ''; document.getElementById('manC').value = '';
    }

    function resetDay() {
        if(confirm("R√©initialiser les nutriments ?")) {
            const auj = new Date().toLocaleDateString();
            db.repas = db.repas.filter(r => r.d !== auj); save(); updateUI();
        }
    }

    // ===== MICRO-LEARNING QCM =====
    
    function getTodayQCM() {
        const auj = new Date().toLocaleDateString();
        if (!db.qcmAnswers) db.qcmAnswers = [];
        
        // V√©rifier si d√©j√† r√©pondu aujourd'hui
        const todayAnswer = db.qcmAnswers.find(a => a.date === auj);
        if (todayAnswer) return null; // D√©j√† fait
        
        // Choisir une question pas encore pos√©e
        const answeredQuestions = db.qcmAnswers.map(a => a.questionIndex);
        const availableQuestions = QCM_QUESTIONS.map((q, i) => i).filter(i => !answeredQuestions.includes(i));
        
        if (availableQuestions.length === 0) {
            // Toutes les questions r√©pondues, reset
            db.qcmAnswers = [];
            return 0;
        }
        
        return availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
    }
    
    async function displayQCM() {
        const content = document.getElementById('qcmContent');
        
        // V√©rifier si d√©j√† r√©pondu aujourd'hui
        const today = new Date().toDateString();
        const lastAnswered = localStorage.getItem('lastQCMAnswered');
        
        if (lastAnswered === today) {
            content.innerHTML = '<div style="text-align:center; padding:20px; color:#8a2be2; font-size:0.75rem;">‚úÖ Question du jour d√©j√† r√©pondue !</div>';
            return;
        }
        
        // Essayer de charger le quiz sauvegard√©
        let question = loadSavedQuiz();
        
        // Si pas de quiz sauvegard√©, en g√©n√©rer un
        if (!question) {
            content.innerHTML = '<div style="padding:15px; color:#888;">G√©n√©ration de la question du jour...</div>';
            question = await genererQuizIA();
        }
        
        // Si l'IA a √©chou√©, utiliser une question par d√©faut
        if (!question) {
            const questionIndex = getTodayQCM();
            if (questionIndex === null) {
                content.innerHTML = '<div style="text-align:center; padding:20px; color:#8a2be2; font-size:0.75rem;">‚úÖ Question du jour d√©j√† r√©pondue !</div>';
                return;
            }
            question = QCM_QUESTIONS[questionIndex];
        }
        
        content.innerHTML = `
            <div class="qcm-question">${question.q}</div>
            <div class="qcm-answers">
                ${question.answers.map((answer, i) => `
                    <div class="qcm-answer" onclick="answerQCMAI(${i})" id="qcm-answer-${i}">
                        ${answer}
                    </div>
                `).join('')}
            </div>
            <div class="qcm-explanation" id="qcmExplanation">
                üí° ${question.explanation}
            </div>
        `;
        
        // Sauvegarder la question actuelle pour la fonction de r√©ponse
        window.currentQCMQuestion = question;
    }
    
    function answerQCMAI(answerIndex) {
        const question = window.currentQCMQuestion || QCM_QUESTIONS[0];
        const correct = question.correct;
        const isCorrect = answerIndex === correct;
        
        // Afficher le r√©sultat
        document.querySelectorAll('.qcm-answer').forEach((el, i) => {
            el.style.pointerEvents = 'none';
            if (i === correct) {
                el.style.background = 'rgba(0, 255, 65, 0.2)';
                el.style.borderColor = 'var(--neon)';
            } else if (i === answerIndex && !isCorrect) {
                el.style.background = 'rgba(255, 68, 68, 0.2)';
                el.style.borderColor = '#ff4444';
            }
        });
        
        document.getElementById('qcmExplanation').style.display = 'block';
        
        // Mettre √† jour le score esprit
        if (isCorrect) {
            db.mindScore = Math.min(100, (db.mindScore || 0) + 10);
            save();
            updateMindScoreUI();
        }
        
        // Marquer comme r√©pondu aujourd'hui
        const today = new Date().toDateString();
        localStorage.setItem('lastQCMAnswered', today);
    }
    
    function answerQCM(questionIndex, answerIndex) {
        const question = QCM_QUESTIONS[questionIndex];
        const isCorrect = answerIndex === question.correct;
        
        // D√©sactiver tous les boutons
        document.querySelectorAll('.qcm-answer').forEach((el, i) => {
            el.classList.add('disabled');
            el.onclick = null;
            
            if (i === question.correct) {
                el.classList.add('correct');
            } else if (i === answerIndex && !isCorrect) {
                el.classList.add('wrong');
            }
        });
        
        // Afficher l'explication
        document.getElementById('qcmExplanation').style.display = 'block';
        
        // Sauvegarder la r√©ponse
        if (!db.qcmAnswers) db.qcmAnswers = [];
        db.qcmAnswers.push({
            date: new Date().toLocaleDateString(),
            questionIndex: questionIndex,
            correct: isCorrect
        });
        
        // Mettre √† jour le score esprit
        if (!db.mindScore) db.mindScore = 0;
        if (isCorrect) {
            db.mindScore += 10;
            setTimeout(() => alert("üéâ +10 points Esprit !"), 300);
        }
        
        save();
        updateMindScoreUI();
    }
    
    function updateMindScoreUI() {
        if (!db.mindScore) db.mindScore = 0;
        document.getElementById('mindScoreDisplay').innerText = db.mindScore;
        document.getElementById('qcmTotalScore').innerText = db.mindScore;
    }

    // ===== GUIDED JOURNAL =====
    
    let selectedTags = [];
    
    function toggleJournalTag(tag) {
        const index = selectedTags.indexOf(tag);
        if (index > -1) {
            selectedTags.splice(index, 1);
        } else {
            selectedTags.push(tag);
        }
        updateJournalTagsUI();
    }
    
    function updateJournalTagsUI() {
        document.querySelectorAll('.journal-tag').forEach(el => {
            const tagName = el.onclick.toString().match(/'(\w+)'/)[1];
            if (selectedTags.includes(tagName)) {
                el.classList.add('active');
            } else {
                el.classList.remove('active');
            }
        });
    }
    
    function saveGuidedJournal() {
        const auj = new Date().toLocaleDateString();
        
        // V√©rifier si journal d√©j√† fait aujourd'hui
        if (!db.guidedJournals) db.guidedJournals = [];
        const alreadyDone = db.guidedJournals.some(j => j.date === auj);
        if (alreadyDone) {
            alert("‚ùå Tu as d√©j√† fait ton journal aujourd'hui !");
            return;
        }
        
        const good = document.getElementById('journalGood').value;
        const block = document.getElementById('journalBlock').value;
        const improve = document.getElementById('journalImprove').value;
        
        if (!good && !block && !improve) {
            alert("Remplis au moins une question !");
            return;
        }
        
        db.guidedJournals.push({
            date: auj,
            good: good,
            block: block,
            improve: improve,
            tags: [...selectedTags]
        });
        
        save();
        
        // R√©initialiser
        document.getElementById('journalGood').value = '';
        document.getElementById('journalBlock').value = '';
        document.getElementById('journalImprove').value = '';
        selectedTags = [];
        updateJournalTagsUI();
        
        updateGuidedJournalUI();
        checkJournalButton();
        alert("‚úÖ Journal enregistr√© !");
    }
    
    function checkJournalButton() {
        const auj = new Date().toLocaleDateString();
        const alreadyDone = db.guidedJournals && db.guidedJournals.some(j => j.date === auj);
        const btn = document.querySelector('button[onclick="saveGuidedJournal()"]');
        
        if (alreadyDone && btn) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
            btn.innerText = '‚úì Journal du jour termin√©';
        }
    }
    
    function updateGuidedJournalUI() {
        if (!db.guidedJournals) db.guidedJournals = [];
        
        const list = document.getElementById('guidedJournalList');
        
        if (db.guidedJournals.length === 0) {
            list.innerHTML = '<p style="text-align:center; color:#666; padding:20px; font-size:0.75rem;">Aucune entr√©e pour le moment</p>';
            return;
        }
        
        const tagColors = {
            energy: '#ff4444',
            focus: '#00d1ff',
            stress: '#ff9800',
            calm: '#00ff41',
            productive: '#8a2be2'
        };
        
        const tagLabels = {
            energy: 'üî¥ √ânergie basse',
            focus: 'üéØ Focus √©lev√©',
            stress: 'üò∞ Stress',
            calm: 'üòå Calme',
            productive: '‚ö° Productif'
        };
        
        list.innerHTML = [...db.guidedJournals].reverse().map(entry => `
            <div class="journal-entry">
                <div class="journal-entry-date">${entry.date}</div>
                ${entry.tags && entry.tags.length > 0 ? `
                    <div class="journal-entry-tags">
                        ${entry.tags.map(tag => `
                            <span class="journal-entry-tag" style="background:${tagColors[tag]}22; color:${tagColors[tag]}; border:1px solid ${tagColors[tag]}">
                                ${tagLabels[tag]}
                            </span>
                        `).join('')}
                    </div>
                ` : ''}
                ${entry.good ? `<div class="journal-entry-text"><strong style="color:var(--neon)">‚úÖ Bien fait:</strong> ${entry.good}</div>` : ''}
                ${entry.block ? `<div class="journal-entry-text"><strong style="color:#ff9800">‚ö†Ô∏è Frein:</strong> ${entry.block}</div>` : ''}
                ${entry.improve ? `<div class="journal-entry-text"><strong style="color:var(--blue)">üéØ Am√©lioration:</strong> ${entry.improve}</div>` : ''}
            </div>
        `).join('');
    }

    function saveNote() {
        const txt = document.getElementById('noteIn').value;
        if(txt) { db.notes.push({txt, d: new Date().toLocaleDateString()}); save(); updateUI(); document.getElementById('noteIn').value = ''; }
    }

    function addT() { 
        // if(isDayLocked()) {
        //     alert("‚ö†Ô∏è Cette journ√©e est verrouill√©e ! Impossible d'ajouter des t√¢ches.");
        //     return;
        // }
        const txt = document.getElementById('tIn').value; 
        if(txt) { 
            db.tasks.push({txt, done: false, d: new Date().toLocaleDateString()}); 
            save(); 
            updateUI(); 
            document.getElementById('tIn').value = ''; 
        } 
    }
    function save() { localStorage.setItem('elite_v14', JSON.stringify(db)); }

    function isDayLocked() {
        const auj = new Date().toLocaleDateString();
        if (!db.lockedDays) db.lockedDays = [];
        return db.lockedDays.includes(auj);
    }

    function openDailyWrap() {
        // if(isDayLocked()) {
        //     alert("Cette journ√©e est d√©j√† verrouill√©e !");
        //     return;
        // }
        
        const auj = new Date().toLocaleDateString();
        const score = calculateDisciplineScore();
        const targetP = Math.round(db.weight * (db.goal === 'pdm' ? 2.2 : 1.8));
        const logs = db.repas.filter(r => r.d === auj);
        const totP = logs.reduce((s, r) => s + r.p, 0);
        const totC = logs.reduce((s, r) => s + r.c, 0);
        const todayTasks = db.tasks.filter(t => t.d === auj);
        const doneTasks = todayTasks.filter(t => t.done).length;
        
        // Remplir l'overlay
        document.getElementById('wrapDate').innerText = auj;
        document.getElementById('wrapScore').innerText = score.total;
        
        // Prot√©ines
        const protEl = document.getElementById('wrapProt');
        protEl.innerText = `${totP}g / ${targetP}g`;
        protEl.className = totP >= targetP ? 'wrap-stat-value success' : 'wrap-stat-value warning';
        
        // Calories
        const calEl = document.getElementById('wrapCal');
        calEl.innerText = `${totC} / 2800`;
        calEl.className = totC >= 2800 ? 'wrap-stat-value success' : 'wrap-stat-value';
        
        // Missions
        const missionsEl = document.getElementById('wrapMissions');
        missionsEl.innerText = `${doneTasks} / ${todayTasks.length}`;
        missionsEl.className = doneTasks === todayTasks.length && todayTasks.length > 0 ? 'wrap-stat-value success' : 'wrap-stat-value';
        
        // Mission critique
        const critEl = document.getElementById('wrapCrit');
        critEl.innerText = db.critDone ? '‚úÖ' : '‚ùå';
        critEl.className = db.critDone ? 'wrap-stat-value success' : 'wrap-stat-value warning';
        
        document.getElementById('dailyWrapOverlay').style.display = 'block';
    }

    function closeDailyWrap() {
        document.getElementById('dailyWrapOverlay').style.display = 'none';
        document.getElementById('wrapImprovement').value = '';
    }

    function lockDay() {
        const auj = new Date().toLocaleDateString();
        const improvement = document.getElementById('wrapImprovement').value;
        
        if (!db.lockedDays) db.lockedDays = [];
        if (!db.improvements) db.improvements = [];
        
        if(!db.lockedDays.includes(auj)) {
            db.lockedDays.push(auj);
        }
        
        if(improvement) {
            db.improvements.push({ date: auj, text: improvement });
        }
        
        save();
        closeDailyWrap();
        updateUI();
        
        // Petit message de confirmation
        alert("üîí Journ√©e verrouill√©e ! Rendez-vous demain pour continuer ta progression.");
    }

    // ===== COACH LOGIC ENGINE =====
    
    function analyzeWeightProgress() {
        // R√©cup√©rer les 10 derniers jours avec poids enregistr√©
        const dates = [...Array(10)].map((_, i) => {
            const d = new Date();
            d.setDate(d.getDate() - i);
            return d.toLocaleDateString();
        }).reverse();
        
        // Pour cet exemple, on simule avec le poids actuel
        // En vrai, il faudrait tracker le poids quotidien
        // Pour l'instant on retourne null (pas de conseil poids)
        return null;
    }
    
    // ===== COACH LOGIQUE - ANALYSE EN TEMPS R√âEL =====

    function getCoachAlerts() {
        const alerts = [];
        const auj = new Date().toLocaleDateString();
        const heures = new Date().getHours();

        // --- DONN√âES DU JOUR ---
        const todayTasks = db.tasks.filter(t => t.d === auj);
        const doneTasks = todayTasks.filter(t => t.done);
        const totalTasks = todayTasks.length;
        const doneCount = doneTasks.length;
        const pctMissions = totalTasks > 0 ? Math.round((doneCount / totalTasks) * 100) : 0;

        const targetP = Math.round(db.weight * (db.goal === 'pdm' ? 2.2 : 1.8));
        const logs = db.repas.filter(r => r.d === auj);
        const totP = logs.reduce((s, r) => s + r.p, 0);
        const pctProt = Math.round((totP / targetP) * 100);

        const todayMood = db.dailyMoods ? db.dailyMoods.find(m => m.date === auj) : null;

        // --- HISTORIQUE ---
        const getDaysBack = (n) => [...Array(n)].map((_, i) => {
            const d = new Date(); d.setDate(d.getDate() - i); return d.toLocaleDateString();
        });

        // === FEEDBACK POSITIF (priorit√© haute) ===

        // Toutes les missions faites
        if (totalTasks >= 3 && doneCount === totalTasks) {
            alerts.push({
                type: 'success',
                title: 'üèÜ Toutes les missions compl√©t√©es !',
                desc: `${doneCount}/${totalTasks} missions termin√©es. Tu es une machine aujourd'hui.`
            });
        }

        // Mission critique faite
        if (db.critTask && db.critDone) {
            alerts.push({
                type: 'success',
                title: '‚úÖ Mission critique termin√©e',
                desc: `"${db.critTask}" est boucl√©e. L'essentiel est fait, le reste c'est du bonus.`
            });
        }

        // Prot√©ines atteintes
        if (pctProt >= 100) {
            alerts.push({
                type: 'success',
                title: 'üí™ Objectif prot√©ines atteint',
                desc: `${totP}g / ${targetP}g (${pctProt}%). Tes muscles te remercient.`
            });
        }

        // Belle streak
        const streak = calculateStreak();
        if (streak >= 3) {
            alerts.push({
                type: 'success',
                title: `üî• Streak de ${streak} jours`,
                desc: streak >= 7 ? `${streak} jours d'affil√©e. Tu es inarr√™table.` : `${streak} jours de discipline. Continue, √ßa devient une habitude.`
            });
        }

        // Score √©lev√© aujourd'hui
        const score = calculateDisciplineScore();
        if (score.total >= 80) {
            alerts.push({
                type: 'success',
                title: '‚≠ê Journ√©e d\'√©lite',
                desc: `Score de ${score.total}/100. C'est le niveau L√©gende.`
            });
        }

        // === ALERTES TEMPS R√âEL (jour en cours) ===

        // Mission critique PAS faite et il est tard
        if (db.critTask && !db.critDone && heures >= 16) {
            alerts.push({
                type: 'critical',
                title: 'üö® Mission critique en attente',
                desc: `"${db.critTask}" n'est toujours pas faite et il est ${heures}h. C'est ta priorit√© #1.`
            });
        }

        // Missions en retard (apr√®s 18h, moins de 50% faites)
        if (totalTasks >= 2 && pctMissions < 50 && heures >= 18) {
            alerts.push({
                type: 'warning',
                title: '‚è∞ Missions en retard',
                desc: `Seulement ${doneCount}/${totalTasks} missions faites (${pctMissions}%) et il est ${heures}h. Fonce sur l'essentiel.`
            });
        }

        // Aucune mission ajout√©e
        if (totalTasks === 0 && heures >= 10) {
            alerts.push({
                type: 'warning',
                title: 'üìã Aucune mission aujourd\'hui',
                desc: 'Tu n\'as pas encore d√©fini tes missions. Une journ√©e sans objectif est une journ√©e perdue.'
            });
        }

        // Prot√©ines en retard (apr√®s midi, moins de 40%)
        if (pctProt < 40 && heures >= 14) {
            alerts.push({
                type: 'warning',
                title: 'üçó Prot√©ines en retard',
                desc: `${totP}g / ${targetP}g (${pctProt}%). Il te reste ${targetP - totP}g √† atteindre.`
            });
        }

        // Mode survie : √©nergie + motivation basses
        if (todayMood && todayMood.energy === 'low' && todayMood.motivation === 'Basse') {
            alerts.push({
                type: 'warning',
                title: 'üîã Mode Survie',
                desc: '√ânergie et motivation basses. Focus uniquement sur : mission critique + prot√©ines. Le reste peut attendre.'
            });
        }

        // === ANALYSE TENDANCES (historique) ===

        // Prot√©ines insuffisantes 2+ jours
        const last3Days = getDaysBack(3);
        let protFailDays = 0;
        last3Days.forEach(date => {
            const dayLogs = db.repas.filter(r => r.d === date);
            const dayP = dayLogs.reduce((s, r) => s + r.p, 0);
            if (dayP > 0 && dayP < targetP * 0.7) protFailDays++;
        });
        if (protFailDays >= 2) {
            alerts.push({
                type: 'warning',
                title: 'üìâ Prot√©ines insuffisantes (tendance)',
                desc: `En-dessous de 70% de ton objectif sur ${protFailDays} des 3 derniers jours. Ajoute un shaker ou du poulet.`
            });
        }

        // Discipline en baisse sur 5 jours
        if (db.disciplineHistory && db.disciplineHistory.length >= 3) {
            const last5Days = getDaysBack(5);
            let lowDays = 0;
            last5Days.forEach(date => {
                const record = db.disciplineHistory.find(h => h.date === date);
                if (record && record.score < 50) lowDays++;
            });
            if (lowDays >= 3) {
                alerts.push({
                    type: 'critical',
                    title: 'üî¥ Discipline en chute',
                    desc: `Score < 50% sur ${lowDays} des 5 derniers jours. R√©duis √† 3 missions max et reconcentre-toi.`
                });
            }
        }

        // Journal : stress ou √©nergie basse r√©currents
        if (db.guidedJournals && db.guidedJournals.length >= 3) {
            const last7Days = getDaysBack(7);
            const recentJournals = db.guidedJournals.filter(j => last7Days.includes(j.date));
            const tagCount = {};
            recentJournals.forEach(j => {
                if (j.tags) j.tags.forEach(tag => { tagCount[tag] = (tagCount[tag] || 0) + 1; });
            });

            if (tagCount['stress'] >= 3) {
                alerts.push({
                    type: 'warning',
                    title: 'üò∞ Stress r√©current',
                    desc: `Stress not√© ${tagCount['stress']} fois en 7 jours. Respire (4s inspire, 4s retiens, 6s expire) et priorise.`
                });
            }
            if (tagCount['energy'] >= 3) {
                alerts.push({
                    type: 'warning',
                    title: '‚ö° √ânergie basse r√©currente',
                    desc: `√ânergie basse ${tagCount['energy']} fois cette semaine. V√©rifie ton sommeil, hydratation et alimentation.`
                });
            }
        }

        return alerts;
    }

    function updateCoachUI() {
        const alerts = getCoachAlerts();
        const alertsContainer = document.getElementById('coachAlerts');
        const badge = document.getElementById('coachBadge');

        const successAlerts = alerts.filter(a => a.type === 'success');
        const problemAlerts = alerts.filter(a => a.type !== 'success');

        if (alerts.length === 0) {
            alertsContainer.innerHTML = '<div class="coach-empty">Tout roule. Continue comme √ßa.</div>';
            badge.innerText = 'RAS';
            badge.style.background = 'rgba(0,255,65,0.2)';
            badge.style.borderColor = 'var(--neon)';
            badge.style.color = 'var(--neon)';
        } else {
            // Compteur : succ√®s en vert, probl√®mes en orange
            const totalProblems = problemAlerts.length;
            const totalSuccess = successAlerts.length;

            if (totalProblems > 0) {
                badge.innerText = `${totalProblems} ALERTE${totalProblems > 1 ? 'S' : ''}`;
                badge.style.background = 'rgba(255,152,0,0.2)';
                badge.style.borderColor = '#ff9800';
                badge.style.color = '#ff9800';
            } else {
                badge.innerText = `${totalSuccess} BRAVO`;
                badge.style.background = 'rgba(0,255,65,0.2)';
                badge.style.borderColor = 'var(--neon)';
                badge.style.color = 'var(--neon)';
            }

            // Afficher succ√®s d'abord, puis alertes
            alertsContainer.innerHTML = [...successAlerts, ...problemAlerts].map(a => `
                <div class="coach-alert ${a.type}" style="${a.type === 'success' ? 'border-left-color: var(--neon); background: rgba(0,255,65,0.05);' : ''}">
                    <div class="coach-alert-title" style="${a.type === 'success' ? 'color: var(--neon);' : ''}">${a.title}</div>
                    <div class="coach-alert-desc">${a.desc}</div>
                </div>
            `).join('');
        }
    }

    // ===== FOCUS MODE =====
    
    let focusTimer = null;
    let focusTimeRemaining = 25 * 60; // Default 25 minutes en secondes
    let focusTotalTime = 25 * 60;
    let focusSelectedMission = null;
    let selectedFocusDuration = 25;
    
    function startFocus() {
        document.getElementById('focusOverlay').style.display = 'flex';
        document.getElementById('focusSelector').style.display = 'block';
        document.getElementById('focusTimer').style.display = 'none';
        document.getElementById('focusComplete').style.display = 'none';
    }
    
    function selectFocusTime(minutes) {
        selectedFocusDuration = minutes;
        document.querySelectorAll('.focus-time-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }
    
    function confirmFocusTime() {
        focusTotalTime = selectedFocusDuration * 60;
        focusTimeRemaining = focusTotalTime;
        
        document.getElementById('focusSelector').style.display = 'none';
        document.getElementById('focusTimer').style.display = 'block';
        updateFocusDisplay();
        
        focusTimer = setInterval(() => {
            focusTimeRemaining--;
            updateFocusDisplay();
            
            if (focusTimeRemaining <= 0) {
                clearInterval(focusTimer);
                showFocusComplete();
            }
        }, 1000);
    }
    
    function updateFocusDisplay() {
        const minutes = Math.floor(focusTimeRemaining / 60);
        const seconds = focusTimeRemaining % 60;
        document.getElementById('focusTimeDisplay').innerText = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Mise √† jour de la barre de progression
        const progress = ((focusTotalTime - focusTimeRemaining) / focusTotalTime) * 100;
        document.getElementById('focusProgressFill').style.width = progress + '%';
        
        // Messages de motivation selon le temps restant
        const messages = [
            "Concentre-toi. Pas de distraction.",
            "Tu es en train de construire ta discipline.",
            "Chaque seconde compte.",
            "La grandeur demande du focus.",
            "Tu es plus fort que tes distractions."
        ];
        
        if (focusTimeRemaining % 300 === 0 && focusTimeRemaining > 0) { // Tous les 5 minutes
            const msgEl = document.getElementById('focusMessage');
            msgEl.innerText = messages[Math.floor(Math.random() * messages.length)];
            msgEl.style.animation = 'none';
            setTimeout(() => msgEl.style.animation = 'fadeIn 0.5s', 10);
        }
    }
    
    function cancelFocusSession() {
        const shouldCancel = confirm("Abandonner cette session de focus ?");
        if (shouldCancel) {
            if (focusTimer) {
                clearInterval(focusTimer);
                focusTimer = null;
            }
            closeFocusOverlay();
        }
    }
    
    function closeFocusOverlay() {
        if (focusTimer) {
            clearInterval(focusTimer);
            focusTimer = null;
        }
        document.getElementById('focusOverlay').style.display = 'none';
        document.getElementById('focusTimer').style.display = 'none';
        document.getElementById('focusSelector').style.display = 'block';
        document.getElementById('focusComplete').style.display = 'none';
        focusSelectedMission = null;
        focusTimeRemaining = 0;
    }
    
    function showFocusComplete() {
        document.getElementById('focusTimer').style.display = 'none';
        document.getElementById('focusComplete').style.display = 'block';
        
        // Remplir la liste des missions
        const auj = new Date().toLocaleDateString();
        const todayTasks = db.tasks.filter(t => t.d === auj && !t.done);
        const listEl = document.getElementById('focusMissionList');
        
        if (todayTasks.length === 0) {
            listEl.innerHTML = '<p style="color:#888; font-size:0.8rem;">Aucune mission disponible</p>';
        } else {
            listEl.innerHTML = todayTasks.map((task, idx) => `
                <div class="focus-mission-item" onclick="selectFocusMission(${db.tasks.indexOf(task)})">
                    <div class="focus-mission-text">${task.txt}</div>
                </div>
            `).join('');
        }
    }
    
    function selectFocusMission(index) {
        focusSelectedMission = index;
        document.querySelectorAll('.focus-mission-item').forEach((el, i) => {
            el.classList.remove('selected');
        });
        event.target.closest('.focus-mission-item').classList.add('selected');
    }
    
    function completeFocusMission() {
        if (focusSelectedMission !== null) {
            db.tasks[focusSelectedMission].done = true;
            save();
            closeFocusOverlay();
            updateUI();
            alert("üéâ Mission valid√©e ! Continue comme √ßa !");
        } else {
            alert("S√©lectionne une mission √† valider");
        }
    }

    async function updateUI() {
        db.weight = parseFloat(document.getElementById('weightIn').value) || db.weight;
        db.goal = document.getElementById('goalSel').value;
        const targetP = Math.round(db.weight * (db.goal === 'pdm' ? 2.2 : 1.8));
        const auj = new Date().toLocaleDateString();
        const logs = db.repas.filter(r => r.d === auj);
        const totP = logs.reduce((s, r) => s + r.p, 0);
        const totC = logs.reduce((s, r) => s + r.c, 0);

        document.getElementById('targetP').innerText = targetP;
        document.getElementById('valP').innerText = totP;
        document.getElementById('valC').innerText = totC;
        
        const pcP = Math.min(100, (totP/targetP)*100);
        const pcC = Math.min(100, (totC/2800)*100);
        document.getElementById('fillP').style.strokeDashoffset = 283 - (283 * pcP / 100);
        document.getElementById('fillC').style.strokeDashoffset = 283 - (283 * pcC / 100);
        document.getElementById('nutriMsg').innerText = totP >= targetP ? "üî• OBJECTIF ATTEINT" : `RESTE ${targetP - totP}G PROT`;

        // Banner Mission Critique
        const b = document.getElementById('criticalBanner');
        if(db.critTask) {
            b.innerText = db.critDone ? "‚úì CRITIQUE TERMIN√â : " + db.critTask : "CRITIQUE : " + db.critTask;
            b.className = db.critDone ? 'isDone' : '';
            b.style.display = 'block';
        }

        const list = document.getElementById('tList'); list.innerHTML = '';
        let done = 0;
        const todayTasks = db.tasks.filter(t => t.d === auj);
        todayTasks.forEach((t, i) => {
            if(t.done) done++;
            const taskIndex = db.tasks.indexOf(t);
            list.innerHTML += `<div class="mission-item" onclick="toggleTask(${taskIndex})">
                <div class="check ${t.done?'done':''}">${t.done?'‚úì':''}</div>
                <span style="${t.done?'text-decoration:line-through;opacity:0.4':''}">${t.txt}</span>
            </div>`;
        });
        const mPc = todayTasks.length ? Math.round((done/todayTasks.length)*100) : 0;
        document.getElementById('mBar').style.width = mPc + '%';
        document.getElementById('missionStatus').innerText = mPc === 100 ? "üèÜ MISSION ACCOMPLIE !" : "DISCIPLINE : " + mPc + "%";

        const phraseIdx = Math.min(Math.floor(mPc / 25), PROGRESS_PHRASES.length - 1);
        document.getElementById('motivLabel').innerText = PROGRESS_PHRASES[phraseIdx];

        document.getElementById('qBox').innerText = `"${MOTIVATION[new Date().getDate() % MOTIVATION.length]}"`;
        
        // Charger ou g√©n√©rer la citation IA
        (async () => {
            const qBoxEl = document.getElementById('qBox');
            const savedQuote = loadSavedQuote();
            
            if (savedQuote) {
                qBoxEl.innerText = `"${savedQuote}"`;
            } else {
                qBoxEl.innerText = '"Chargement de votre citation du jour..."';
                const aiQuote = await genererCitationIA();
                qBoxEl.innerText = `"${aiQuote}"`;
            }
        })();
        
        // Charger ou g√©n√©rer le mot du jour IA
        (async () => {
            const mTxtEl = document.getElementById('mTxt');
            const savedWord = loadSavedWord();
            
            if (savedWord) {
                const parts = savedWord.split(' : ');
                if (parts.length === 2) {
                    mTxtEl.innerHTML = `<b style="color:var(--neon)">${parts[0]}</b> : ${parts[1]}`;
                } else {
                    mTxtEl.innerHTML = savedWord;
                }
            } else {
                mTxtEl.innerHTML = 'Chargement du mot du jour...';
                const aiWord = await genererMotIA();
                const parts = aiWord.split(' : ');
                if (parts.length === 2) {
                    mTxtEl.innerHTML = `<b style="color:var(--neon)">${parts[0]}</b> : ${parts[1]}`;
                } else {
                    mTxtEl.innerHTML = aiWord;
                }
            }
        })();
        
        updateGuidedJournalUI();
        
        // Afficher badge si journ√©e verrouill√©e
        const headerDateEl = document.getElementById('headerDate');
        headerDateEl.innerHTML = auj; // isDayLocked() ? `${auj}<span class="locked-badge">Verrouill√©e</span>` : auj;
        
        // Mise √† jour du score de discipline
        updateDisciplineUI();
        
        // Mise √† jour du coach
        updateCoachUI();
        
        // Mise √† jour du QCM et score esprit
        await displayQCM();
        updateMindScoreUI();
        checkJournalButton();
        
        initChart();
    }

    function toggleTask(index) {
        // if(isDayLocked()) {
        //     alert("‚ö†Ô∏è Cette journ√©e est verrouill√©e ! Impossible de modifier.");
        //     return;
        // }
        if(db.tasks[index]) {
            db.tasks[index].done = !db.tasks[index].done;
            save();
            updateUI();
        }
    }

    let chart;
    function initChart() {
        const canvas = document.getElementById('chart');
        if(!canvas) return;
        const ctx = canvas.getContext('2d');
        if(chart) chart.destroy();
        const dates = [...Array(7)].map((_, i) => { const d = new Date(); d.setDate(d.getDate()-i); return d.toLocaleDateString(); }).reverse();
        const dataset = dates.map(d => db.repas.filter(r => r.d === d).reduce((s, r) => s + r.p, 0));
        chart = new Chart(ctx, {
            type: 'line',
            data: { labels: dates.map(d => d.split('/')[0]), datasets: [{ data: dataset, borderColor: '#00ff41', tension: 0.4, fill: true, backgroundColor: 'rgba(0,255,65,0.05)', pointRadius: 0 }] },
            options: { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: '#444' } } } }
        });
    }

    document.getElementById('weightIn').value = db.weight;
    document.getElementById('goalSel').value = db.goal;
    checkStart();
    updateUI();

    // ===== CHEF IA =====

    function showChefIA() {
        document.getElementById('chefIASection').style.display = 'block';
    }

    // On affiche Chef IA d√®s que le tab Nutrition est actif
    const _origSwitchTab = switchTab;
    switchTab = function(t, el) {
        _origSwitchTab(t, el);
        document.getElementById('chefIASection').style.display = (t === 'food') ? 'block' : 'none';
    };
    // Afficher aussi au chargement initial si le tab food est actif
    showChefIA();

</script>

<script>
// Historique de conversation
let conversationHistory = [];

// Fonction pour convertir le Markdown basique en HTML
function markdownToHTML(text) {
    return text
        // Titres
        .replace(/^### (.*$)/gim, '<h3 style="color:var(--neon); font-size:1rem; font-weight:900; margin:12px 0 8px 0;">$1</h3>')
        .replace(/^## (.*$)/gim, '<h2 style="color:var(--neon); font-size:1.1rem; font-weight:900; margin:14px 0 10px 0;">$1</h2>')
        .replace(/^# (.*$)/gim, '<h1 style="color:var(--neon); font-size:1.2rem; font-weight:900; margin:16px 0 12px 0;">$1</h1>')
        // Gras et italique
        .replace(/\*\*(.*?)\*\*/g, '<strong style="color:var(--blue);">$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // Listes
        .replace(/^\*   (.*$)/gim, '<li style="margin-left:20px;">$1</li>')
        .replace(/^- (.*$)/gim, '<li style="margin-left:20px;">$1</li>')
        // Sauts de ligne
        .replace(/\n\n/g, '<br><br>')
        .replace(/\n/g, '<br>');
}

async function demanderIA() {
    const input = document.getElementById('userInput'); 
    const responseDiv = document.getElementById('zone-reponse');
    const historyDiv = document.getElementById('conversation-history');
    
    if (!input || !input.value.trim()) return alert("√âcris quelque chose !");

    const userMessage = input.value.trim();
    
    // Ajouter le message utilisateur √† l'historique
    conversationHistory.push({ role: 'user', content: userMessage });
    
    // Afficher le message utilisateur
    const userMsgDiv = document.createElement('div');
    userMsgDiv.style.cssText = 'padding:10px; margin-bottom:8px; background:rgba(0,255,65,0.1); border-left:3px solid var(--neon); border-radius:8px; font-size:0.75rem;';
    userMsgDiv.innerHTML = `<strong style="color:var(--neon);">Vous :</strong><br>${userMessage}`;
    historyDiv.appendChild(userMsgDiv);
    
    // Vider l'input
    input.value = '';
    
    // Afficher le chargement
    responseDiv.style.display = "block";
    responseDiv.innerHTML = "ü§ñ L'IA r√©fl√©chit...";

    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: userMessage })
        });

        const data = await response.json();

        if (data.error) {
            console.error("Erreur API:", data.error, data.debug || "");
            const msg = data.error.message || data.error;
            const hint = data.debug ? `<br><br><small style="color:#888;">${data.debug}</small>` : "";
            responseDiv.innerHTML = `‚ùå Erreur: ${msg}${hint}`;
            return;
        }

        if (data.candidates && data.candidates[0]) {
            const candidate = data.candidates[0];
            
            if (candidate.content && candidate.content.parts && candidate.content.parts[0]) {
                const texteIA = candidate.content.parts[0].text;
                
                // Ajouter la r√©ponse √† l'historique
                conversationHistory.push({ role: 'assistant', content: texteIA });
                
                // Afficher la r√©ponse format√©e dans l'historique
                const aiMsgDiv = document.createElement('div');
                aiMsgDiv.style.cssText = 'padding:12px; margin-bottom:12px; background:rgba(0,209,255,0.05); border-left:3px solid var(--blue); border-radius:8px; font-size:0.78rem; line-height:1.6;';
                aiMsgDiv.innerHTML = `<strong style="color:var(--blue);">Chef IA :</strong><br><br>${markdownToHTML(texteIA)}`;
                historyDiv.appendChild(aiMsgDiv);
                
                // Masquer la zone de chargement
                responseDiv.style.display = "none";
                
                // Scroll vers le bas
                historyDiv.scrollTop = historyDiv.scrollHeight;
            } else {
                console.error("Structure candidate incorrecte:", candidate);
                responseDiv.innerHTML = "‚ö†Ô∏è Format de r√©ponse inattendu.";
            }
        } else {
            console.error("Structure compl√®te re√ßue:", JSON.stringify(data, null, 2));
            responseDiv.innerHTML = "‚ö†Ô∏è L'IA a r√©pondu, mais le format est inconnu.";
        }

    } catch (error) {
        responseDiv.innerHTML = "‚ùå Erreur de connexion.";
        console.error(error);
    }
}

// Permettre d'envoyer avec Enter (mais Shift+Enter pour nouvelle ligne)
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('userInput');
    if(input) {
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                demanderIA();
            }
        });
    }
});
</script>

<script>
// ===== PWA + NOTIFICATIONS LOCALES =====

let swRegistration = null;

// Enregistrer le Service Worker et attendre qu'il soit pr√™t
async function initServiceWorker() {
    if (!('serviceWorker' in navigator)) return null;
    try {
        const reg = await navigator.serviceWorker.register('sw.js');
        // Attendre que le SW soit actif
        if (reg.active) {
            swRegistration = reg;
        } else {
            // Attendre l'activation
            const sw = reg.installing || reg.waiting;
            if (sw) {
                await new Promise(resolve => {
                    sw.addEventListener('statechange', () => {
                        if (sw.state === 'activated') resolve();
                    });
                    if (sw.state === 'activated') resolve();
                });
            }
            swRegistration = reg;
        }
        console.log('‚úÖ Service Worker pr√™t');
        return reg;
    } catch (err) {
        console.log('SW erreur:', err);
        return null;
    }
}

// Demander la permission de notifier
async function demanderPermissionNotif() {
    if (!('Notification' in window)) return false;
    if (Notification.permission === 'granted') return true;
    if (Notification.permission === 'denied') return false;
    const perm = await Notification.requestPermission();
    return perm === 'granted';
}

// Programmer une notification via setTimeout dans le SW
function programmerNotif(titre, message, delaiMs) {
    if (!swRegistration) return;
    // Utiliser le SW actif directement
    const sw = swRegistration.active;
    if (sw) {
        sw.postMessage({
            type: 'SCHEDULE_NOTIFICATION',
            title: titre,
            body: message,
            delay: delaiMs
        });
    }
}

// Envoyer une notification imm√©diate
function envoyerNotif(titre, message) {
    if (!swRegistration || Notification.permission !== 'granted') return;
    swRegistration.showNotification(titre, {
        body: message,
        icon: 'Logo.png',
        badge: 'Logo.png',
        vibrate: [200, 100, 200],
        tag: 'elite-' + Date.now()
    });
}

// ===== RAPPELS AUTOMATIQUES =====

function lancerRappels() {
    if (Notification.permission !== 'granted' || !swRegistration) return;

    const maintenant = new Date();

    const tousRappels = [
        { h: 9, m: 0, titre: 'üéØ Mission du jour', msg: 'C\'est l\'heure de ta mission critique ! Go go go !' },
        { h: 12, m: 0, titre: 'üçó Rappel Nutrition', msg: 'T\'as pens√© √† tracker tes prot√©ines ce midi ?' },
        { h: 14, m: 0, titre: 'üß† Temps de Focus', msg: 'Lance une session focus de 25 min !' },
        { h: 17, m: 0, titre: '‚ö° Check missions', msg: 'T\'as compl√©t√© tes missions aujourd\'hui ?' },
        { h: 19, m: 0, titre: 'ü•ó Rappel D√Æner', msg: 'N\'oublie pas de tracker ton repas du soir !' }
    ];

    tousRappels.forEach(r => {
        const cible = new Date();
        cible.setHours(r.h, r.m, 0, 0);
        if (cible <= maintenant) cible.setDate(cible.getDate() + 1);
        const delai = cible - maintenant;
        programmerNotif(r.titre, r.msg, delai);
    });

    console.log('üìå Rappels programm√©s');
}

// Banni√®re pour demander les notifications
function afficherBanniereNotif() {
    if (!('Notification' in window)) return;
    if (Notification.permission !== 'default') return; // D√©j√† accept√© ou refus√©
    if (localStorage.getItem('notif_banner_dismissed')) return;

    const banner = document.createElement('div');
    banner.id = 'notifBanner';
    banner.style.cssText = 'position:fixed; bottom:0; left:0; right:0; background:linear-gradient(135deg, #12161c, #1a1f2e); border-top:2px solid var(--neon); padding:16px 20px; z-index:9998; display:flex; align-items:center; justify-content:space-between; gap:12px;';
    banner.innerHTML = `
        <div style="flex:1;">
            <div style="font-weight:900; font-size:0.8rem; color:var(--neon); margin-bottom:4px;">üîî Activer les rappels ?</div>
            <div style="font-size:0.7rem; color:#888;">Re√ßois des notifications pour tes missions, prot√©ines et focus.</div>
        </div>
        <button onclick="activerNotifs()" style="background:var(--neon); color:black; border:none; padding:10px 18px; border-radius:10px; font-weight:900; font-size:0.7rem; cursor:pointer; white-space:nowrap;">ACTIVER</button>
        <button onclick="fermerBanniereNotif()" style="background:transparent; border:1px solid #444; color:#888; padding:8px 12px; border-radius:10px; font-size:0.65rem; cursor:pointer;">Non</button>
    `;
    document.body.appendChild(banner);
}

async function activerNotifs() {
    const autorise = await demanderPermissionNotif();
    const banner = document.getElementById('notifBanner');
    if (banner) banner.remove();

    if (autorise) {
        // Notif de test imm√©diate
        envoyerNotif('‚úÖ Notifications activ√©es', 'Tu recevras des rappels pour tes missions et ta nutrition.');
        lancerRappels();
    }
}

function fermerBanniereNotif() {
    const banner = document.getElementById('notifBanner');
    if (banner) banner.remove();
    localStorage.setItem('notif_banner_dismissed', 'true');
}

// Au chargement : init SW puis notifications
document.addEventListener('DOMContentLoaded', async () => {
    await initServiceWorker();

    if (Notification.permission === 'granted') {
        // D√©j√† autoris√© ‚Üí lancer les rappels directement
        lancerRappels();
    } else {
        // Pas encore demand√© ‚Üí afficher la banni√®re
        afficherBanniereNotif();
    }
});
</script>
</body>
</html>
